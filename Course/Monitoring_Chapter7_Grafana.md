# آموزش پرومتئوس - قسمت هفتم: ساخت داشبورد با گرافانا

در این قسمت از سری آموزش‌های پرومتئوس، به نحوه استفاده از **گرافانا** (Grafana) برای ساخت داشبوردهای بصری مبتنی بر داده‌های پرومتئوس می‌پردازیم. گرافانا یک ابزار متن‌باز قدرتمند برای ایجاد داشبوردهای بصری است که به‌خوبی با پرومتئوس ادغام می‌شود. هدف این آموزش، ارائه یک راهنمای عمیق و کاربردی برای راه‌اندازی گرافانا، اتصال آن به پرومتئوس، و ساخت داشبورد با سه نوع پنل: نمودار سری زمانی، گیج (Gauge)، و جدول. همچنین با مثال‌های عملی، نحوه استفاده از این ابزار را به‌صورت کامل توضیح می‌دهیم.

## چرا گرافانا؟
پرومتئوس به‌تنهایی قابلیت‌های کامل داشبوردینگ ندارد و بیشتر برای جمع‌آوری و ذخیره متریک‌ها طراحی شده است. گرافانا این کمبود را جبران می‌کند و با ارائه رابط کاربری بصری، امکان ایجاد داشبوردهای تعاملی و جذاب را فراهم می‌کند. گرافانا از PromQL پشتیبانی می‌کند و به شما امکان می‌دهد داده‌های پرومتئوس را به‌صورت گرافیکی نمایش دهید.

## قدم اول: نصب و راه‌اندازی گرافانا

برای شروع، باید گرافانا را نصب و اجرا کنیم. دو روش اصلی برای این کار وجود دارد:

### روش ۱: استفاده از داکر
گرافانا به‌صورت یک ایمیج داکر در دسترس است که راه‌اندازی آن بسیار ساده است.

**دستور نمونه:**
```bash
docker run -d -p 3000:3000 --name grafana -v grafana-data:/var/lib/grafana grafana/grafana
```
- **توضیحات:**
  - ` آپشن -d`: اجرای داکر در حالت پس‌زمینه.
  - ` قسمت p 3000:3000-`: نگاشت پورت ۳۰۰۰ برای دسترسی به گرافانا.
  - ` قسمت v grafana-data:/var/lib/grafana-`: ایجاد یک ولوم برای ذخیره دائمی داشبوردها.

### روش ۲: استفاده از فایل‌های باینری
گرافانا فایل‌های باینری آماده برای سیستم‌عامل‌های مختلف (مثل لینوکس) ارائه می‌دهد.

**مراحل:**
1. به وب‌سایت [grafana.com](https://grafana.com) بروید و بخش **Downloads > Self-Managed > Grafana** را انتخاب کنید.
2. فایل باینری لینوکس را دانلود کنید.
3. فایل را در یک پوشه (مثلاً `~/grafana`) استخراج کنید:
   ```bash
   tar -zxvf grafana-x.x.x.linux-amd64.tar.gz
   cd grafana-x.x.x
   ```
4. گرافانا را اجرا کنید:
   ```bash
   ./bin/grafana-server
   ```

گرافانا روی پورت ۳۰۰۰ اجرا می‌شود. در مرورگر به آدرس `http://localhost:3000` بروید و با نام کاربری و رمز عبور پیش‌فرض (`admin`/`admin`) وارد شوید. برای امنیت، بهتر است رمز عبور را تغییر دهید.

## قدم دوم: اتصال گرافانا به پرومتئوس

برای استفاده از داده‌های پرومتئوس، باید گرافانا را به سرور پرومتئوس متصل کنیم.

**مراحل:**
1. در گرافانا، به منوی **Connections > Data Sources** بروید و **Add data source** را انتخاب کنید.
2. نوع منبع داده را **Prometheus** انتخاب کنید.
3. تنظیمات زیر را وارد کنید:
   - **Name**: نامی مثل `Prometheus-Demo`.
   - **URL**: آدرس سرور پرومتئوس (مثلاً `http://demo.promlabs.com:9090` برای سرور دموی PromLabs).
   - **Default**: اگر اولین منبع داده است، تیک گزینه Default را بزنید.
4. روی **Save & Test** کلیک کنید تا اتصال بررسی شود.

**نکته:** اگر سرور پرومتئوس شما نیاز به احراز هویت دارد، تنظیمات HTTP و Authentication را پیکربندی کنید.

**مثال عملی:** فرض کنید از سرور دموی PromLabs استفاده می‌کنید. پس از تنظیم منبع داده، می‌توانید کوئری‌های PromQL را مستقیماً در گرافانا اجرا کنید.

## قدم سوم: ساخت داشبورد

حالا که گرافانا به پرومتئوس متصل است، می‌توانیم یک داشبورد جدید بسازیم. در منوی **Dashboards**، گزینه **New Dashboard** را انتخاب کنید. در ادامه، سه نوع پنل را ایجاد می‌کنیم: **نمودار سری زمانی**، **گیج**، و **جدول**.

### ۱. پنل نمودار سری زمانی (Time Series)
این پنل برای نمایش تغییرات متریک‌ها در طول زمان مناسب است.

**مراحل:**
1. در داشبورد، روی **Add > Visualization** کلیک کنید و نوع پنل را **Time Series** انتخاب کنید.
2. بازه زمانی را به ۳۰ دقیقه تنظیم کنید (در منوی بالا).
3. یک کوئری PromQL وارد کنید. مثلاً:
   ```promql
   histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path, method))
   ```
   - این کوئری صدک ۹۵ (95th percentile) تأخیر درخواست‌های HTTP را برای هر مسیر (path) و متد (method) محاسبه می‌کند.
4. **تنظیمات پنل:**
   - **عنوان:** «تأخیر صدک ۹۵ درخواست‌ها»
   - **واحد:** در بخش Panel Options، واحد را به **Seconds** تنظیم کنید تا گرافانا مقادیر را به‌درستی (مثلاً در میلی‌ثانیه) نمایش دهد.
   - **فرمت لجند:** برای خواناتر شدن لجند، به بخش Query Options بروید و فرمت دلخواه را وارد کنید:
     ```
     {{path}} - {{method}}
     ```
     این کار لجند را به‌صورت `path-method` (مثلاً `/api/get - GET`) نمایش می‌دهد.
5. روی **Apply** کلیک کنید تا پنل ذخیره شود.

**مثال عملی:**
فرض کنید وب‌سرویسی دارید که تأخیر درخواست‌ها را مانیتور می‌کنید. این پنل نشان می‌دهد که مسیر `/api/login` تأخیر بیشتری نسبت به `/api/status` دارد. می‌توانید از این اطلاعات برای شناسایی گلوگاه‌ها استفاده کنید.

### ۲. پنل گیج (Gauge)
این پنل برای نمایش یک مقدار لحظه‌ای (مثل درصد استفاده از CPU) مناسب است.

**مراحل:**
1. یک پنل جدید اضافه کنید و نوع آن را **Gauge** انتخاب کنید.
2. کوئری PromQL زیر را وارد کنید:
   ```promql
   avg(rate(node_cpu_seconds_total{mode="user"}[5m]))
   ```
   - این کوئری میانگین استفاده از CPU در حالت کاربر (user mode) را برای چند نمونه محاسبه می‌کند.
3. **تنظیمات پنل:**
   - **عنوان:** «استفاده لحظه‌ای از CPU»
   - **واحد:** در بخش Panel Options، واحد را به **Percent (0.0-1.0)** تنظیم کنید.
   - **حداقل و حداکثر:** حداقل را ۰ و حداکثر را ۱ تنظیم کنید.
   - **آستانه‌ها (Thresholds):** آستانه قرمز را روی ۰.۸ (معادل ۸۰٪) تنظیم کنید تا استفاده بالای ۸۰٪ به رنگ قرمز نمایش داده شود.
4. روی **Apply** کلیک کنید.

**مثال عملی:**
اگر سرور شما سه نمونه (instance) دارد، این پنل استفاده CPU هر نمونه را به‌صورت گیج نشان می‌دهد. اگر گیج یکی از نمونه‌ها قرمز شود، می‌توانید سریعاً بررسی کنید که آیا سرور تحت فشار است یا خیر.

### ۳. پنل جدول (Table)
این پنل برای نمایش داده‌های لحظه‌ای به‌صورت جدولی مناسب است.

**مراحل:**
1. یک پنل جدید اضافه کنید و نوع آن را **Table** انتخاب کنید.
2. کوئری PromQL زیر را وارد کنید:
   ```promql
   topk(3, sum(rate(http_requests_total[5m])) by (path, method))
   ```
   - این کوئری سه مسیر و متد با بالاترین نرخ درخواست را نشان می‌دهد.
3. **تنظیمات پنل:**
   - **فرمت:** در بخش Query Options، فرمت را به **Table** تغییر دهید.
   - **نوع کوئری:** نوع را به **Instant** تغییر دهید تا فقط آخرین مقدار هر سری زمانی نمایش داده شود.
   - **حذف ستون زمان:** دو روش وجود دارد:
     1. از بخش **Transform**، گزینه **Organize Fields** را انتخاب کنید و ستون زمان را مخفی کنید.
     2. از بخش **Field Options**، یک override برای فیلد نوع **Time** اضافه کنید و آن را مخفی کنید.
   - **واحد:** واحد را به **Requests/s** تنظیم کنید.
   - **عنوان:** «سه نرخ درخواست برتر»
4. روی **Apply** کلیک کنید.

**مثال عملی:**
این جدول نشان می‌دهد که مسیر `/api/get` با متد `GET` بالاترین نرخ درخواست را دارد. می‌توانید از این داده‌ها برای بهینه‌سازی مسیرهای پرترافیک استفاده کنید.

## سازمان‌دهی داشبورد با ردیف‌ها (Rows)

برای مرتب‌سازی پنل‌ها، می‌توانید آن‌ها را در ردیف‌های موضوعی گروه‌بندی کنید.

**مراحل:**
1. در داشبورد، روی **Add > Row** کلیک کنید و دو ردیف به نام‌های «آمار HTTP» و «آمار CPU» ایجاد کنید.
2. پنل‌ها را با drag-and-drop به ردیف مناسب منتقل کنید (مثلاً پنل‌های سری زمانی و جدول به «آمار HTTP» و گیج به «آمار CPU»).
3. برای ذخیره داشبورد، روی آیکون ذخیره کلیک کنید و نامی مثل «دمو داشبورد» انتخاب کنید.

**مثال عملی:**
با این سازمان‌دهی، داشبورد شما خواناتر می‌شود. مثلاً تیم شبکه می‌تواند روی ردیف «آمار HTTP» تمرکز کند، در حالی که تیم زیرساخت روی «آمار CPU» نظارت می‌کند.

## نکات کاربردی

1. **متغیرهای قالب گرافانا:** گرافانا از متغیرهایی مثل `$__rate_interval` پشتیبانی می‌کند که بازه مناسب برای کوئری‌های `rate` را به‌صورت خودکار تنظیم می‌کند.
   ```promql
   rate(http_requests_total[$__rate_interval])
   ```
2. **هشدار در گرافانا:** می‌توانید هشدارهایی بر اساس کوئری‌های PromQL تنظیم کنید. مثلاً:
   ```promql
   ALERT HighCPULoad
     IF avg(rate(node_cpu_seconds_total{mode="user"}[5m])) > 0.8
     FOR 5m
     LABELS { severity = "warning" }
     ANNOTATIONS {
       summary = "بار CPU بالا",
       description = "استفاده CPU در {{ $labels.instance }} بیش از ۸۰٪ است."
     }
   ```
3. **بهینه‌سازی کوئری‌ها:** از توابع `sum`، `avg`، و `topk` برای کاهش تعداد سری‌های زمانی در داشبورد استفاده کنید تا عملکرد بهبود یابد.
4. **ذخیره‌سازی دائمی:** اگر از داکر استفاده می‌کنید، حتماً از ولوم برای ذخیره دائمی داشبوردها استفاده کنید.

## مثال جامع: داشبورد مانیتورینگ وب‌سرویس
فرض کنید یک وب‌سرویس دارید که می‌خواهید متریک‌های زیر را مانیتور کنید:
- **تأخیر درخواست‌ها:** صدک ۹۵ تأخیر برای هر مسیر.
- **نرخ درخواست‌ها:** سه مسیر پرترافیک.
- **استفاده CPU:** درصد استفاده CPU برای هر نمونه.

**داشبورد پیشنهادی:**
- **ردیف HTTP Stats:**
  - پنل سری زمانی: `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path))`
  - پنل جدول: `topk(3, sum(rate(http_requests_total[5m])) by (path))`
- **ردیف CPU Stats:**
  - پنل گیج: `avg(rate(node_cpu_seconds_total{mode="user"}[5m]))`

این داشبورد به شما دید کلی از عملکرد وب‌سرویس و سلامت سرورها می‌دهد.

## مستندات و منابع
برای اطلاعات بیشتر، به مستندات گرافانا در [grafana.com/docs](https://grafana.com/docs) یا مستندات پرومتئوس مراجعه کنید. همچنین، سرور دموی PromLabs (`demo.promlabs.com`) برای تمرین عالی است.

## جمع‌بندی
گرافانا ابزاری قدرتمند برای بصری‌سازی داده‌های پرومتئوس است. با نصب گرافانا، اتصال آن به پرومتئوس، و ایجاد پنل‌های سری زمانی، گیج، و جدول، می‌توانید داشبوردهایی بسازید که اطلاعات کلیدی سیستم را به‌صورت واضح نمایش دهند. سازمان‌دهی پنل‌ها در ردیف‌ها و استفاده از متغیرهای گرافانا، کارایی داشبورد را افزایش می‌دهد. برای یادگیری عمیق‌تر، به دوره‌های آموزشی پرومتئوس و گرافانا مراجعه کنید یا سوالات خود را در بخش نظرات مطرح کنید!
