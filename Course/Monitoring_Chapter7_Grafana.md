# آموزش پرومتئوس - قسمت هفتم: ساخت داشبورد با گرافانا

در این قسمت از سری آموزش‌های پرومتئوس، به نحوه استفاده از **گرافانا** (Grafana) برای ساخت داشبوردهای بصری مبتنی بر داده‌های پرومتئوس می‌پردازیم. گرافانا یک ابزار متن‌باز قدرتمند برای ایجاد داشبوردهای بصری است که به‌خوبی با پرومتئوس ادغام می‌شود. هدف این آموزش، ارائه یک راهنمای عمیق و کاربردی برای راه‌اندازی گرافانا، اتصال آن به پرومتئوس، و ساخت داشبورد با سه نوع پنل: نمودار سری زمانی، گیج (Gauge)، و جدول. همچنین با مثال‌های عملی، نحوه استفاده از این ابزار را به‌صورت کامل توضیح می‌دهیم.

## چرا گرافانا؟
پرومتئوس به‌تنهایی قابلیت‌های کامل داشبوردینگ ندارد و بیشتر برای جمع‌آوری و ذخیره متریک‌ها طراحی شده است. گرافانا این کمبود را جبران می‌کند و با ارائه رابط کاربری بصری، امکان ایجاد داشبوردهای تعاملی و جذاب را فراهم می‌کند. گرافانا از PromQL پشتیبانی می‌کند و به شما امکان می‌دهد داده‌های پرومتئوس را به‌صورت گرافیکی نمایش دهید.

## قدم صفر:  بررسی پیش‌نیازها
قبل از شروع نصب، مطمئن شوید که سیستم شما شرایط زیر را دارد:

- **سیستم‌عامل**: اوبونتو 20.04 یا 22.04 (یا نسخه‌های مشابه لینوکس).
- **دسترسی root یا sudo**: برای اجرای دستورات نصب.
- **اتصال به اینترنت**: برای دانلود بسته‌های گرافانا.
- **فایروال (اختیاری)**: اگر از فایروال استفاده می‌کنید، پورت 3000 (پورت پیش‌فرض گرافانا) باید باز باشد.
- **منابع سخت‌افزاری**: حداقل 1 گیگابایت رم و پردازنده 1 گیگاهرتز (برای بارهای کاری سنگین، منابع بیشتری توصیه می‌شود).


## قدم اول: نصب گرافانا

### روش ۱: استفاده از داکر
گرافانا به‌صورت یک ایمیج داکر در دسترس است که راه‌اندازی آن بسیار ساده است.

**دستور نمونه:**
```bash
docker run -d -p 3000:3000 --name grafana -v grafana-data:/var/lib/grafana grafana/grafana
```
- **توضیحات:**
  - ` آپشن -d`: اجرای داکر در حالت پس‌زمینه.
  - ` قسمت p 3000:3000-`: نگاشت پورت ۳۰۰۰ برای دسترسی به گرافانا.
  - ` قسمت v grafana-data:/var/lib/grafana-`: ایجاد یک ولوم برای ذخیره دائمی داشبوردها.

### روش ۲: استفاده از فایل‌های باینری
گرافانا فایل‌های باینری آماده برای سیستم‌عامل‌های مختلف (مثل لینوکس) ارائه می‌دهد.

### روش 3: قدم به قدم با خود سایت گرافانا

1. به لینک [grafana.com]([https://grafana.com](https://grafana.com/docs/grafana/latest/setup-grafana/installation/)) بروید.
2. سیستم عامل مدنظر یا توزیع آن را انتخاب کنیدو طبق آموزش ها پیش بروید.

<img width="293" height="507" alt="image" src="https://github.com/user-attachments/assets/f808a3d8-c96e-4d0a-96ff-0148cc4ecf65" />

### روش 4: قدم به قدم با خودم

1. بسته‌های پیش‌نیاز را نصب کنید.
```bash
sudo apt-get install -y apt-transport-https software-properties-common wget gnupg2 curl
```
2. کلید GPG را وارد کنید.
```bash
sudo mkdir -p /etc/apt/keyrings/
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
```
3. برای اضافه کردن مخزن برای نسخه‌های پایدار، دستور زیر را اجرا کنید:
```bash
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
```

4. برای به‌روزرسانی لیست بسته‌های موجود، دستور زیر را اجرا کنید:
```bash
# Updates the list of available packages
sudo apt-get update
```

5. برای نصب Grafana OSS/Enterprise، دستورات زیر را اجرا کنید:
```bash
# Installs the latest OSS release:
sudo apt-get install grafana
# Installs the latest Enterprise release:
sudo apt-get install grafana-enterprise
```

6. بررسی نسخه نصب‌شده :
```bash
grafana-server --version
```


## قدم دوم: راه‌اندازی گرافانا

گرافانا به صورت یک سرویس سیستمی نصب می‌شود و از `systemd` برای مدیریت استفاده می‌کند.

### **۱. فعال‌سازی و شروع سرویس**
سرویس گرافانا را فعال کنید تا پس از ری‌استارت سیستم به صورت خودکار اجرا شود:
```bash
sudo systemctl enable grafana-server
sudo systemctl start grafana-server
```

### **۲. بررسی وضعیت سرویس**
برای اطمینان از اجرای صحیح سرویس:
```bash
sudo systemctl status grafana-server
```
خروجی باید نشان دهد که سرویس در حالت `active (running)` است.



### **3. سترسی به رابط کاربری گرافانا**

گرافانا به صورت پیش‌فرض روی پورت 3000 اجرا می‌شود.

1. مرورگر خود را باز کنید.
2. آدرس زیر را وارد کنید:
   ```
   http://<آدرس_IP_سرور>:3000
   ```
   یا اگر روی سیستم محلی نصب کرده‌اید:
   ```
   http://localhost:3000
   ```

### **ورود به سیستم**
- **نام کاربری پیش‌فرض**: `admin`
- **رمز عبور پیش‌فرض**: `admin`

پس از اولین ورود، از شما خواسته می‌شود رمز عبور پیش‌فرض را تغییر دهید. حتماً یک رمز عبور قوی انتخاب کنید.



## قدم سوم: اتصال گرافانا به پرومتئوس

برای استفاده از داده‌های پرومتئوس، باید گرافانا را به سرور پرومتئوس متصل کنیم.

**مراحل:**
1. در گرافانا، به منوی **Connections > Data Sources** بروید و **Add data source** را انتخاب کنید.
2. نوع منبع داده را **Prometheus** انتخاب کنید.
3. تنظیمات زیر را وارد کنید:
   - **قسمت Name**: نامی مثل `Prometheus-Demo`.
   - **قسمت URL**: آدرس سرور پرومتئوس (مثلاً `http://demo.promlabs.com:9090` برای سرور دموی PromLabs).
   - **قسمت Default**: اگر اولین منبع داده است، تیک گزینه Default را بزنید.

4. روی **Save & Test** کلیک کنید تا اتصال بررسی شود.

**نکته:** اگر سرور پرومتئوس شما نیاز به احراز هویت دارد، تنظیمات HTTP و Authentication را پیکربندی کنید.

**مثال عملی:** فرض کنید از سرور دموی PromLabs استفاده می‌کنید. پس از تنظیم منبع داده، می‌توانید کوئری‌های PromQL را مستقیماً در گرافانا اجرا کنید.




## قدم چهارم: ساخت داشبورد

حالا که گرافانا به پرومتئوس متصل است و منابع تایم سری ها به گرافانا متصل شده حالا باید بیایم یک داشبوردی متشکل از یک یا چند نمودار- جدول و یا ... درست کنیم که داده ها را به مقصود نهایی ما که نمایش بود برساند.
برای این منظور دو راه داریم :

- یا از داشبورد های از پیش آماده شده استفاده کنید.
- یا اینکه خودمون شخصی سازی شده یک داشبورد بسازیم .

## 1. روش اضافه کردن داشبورد آماده

### **مرحله ۱: یافتن داشبورد آماده**
1. به وب‌سایت [Grafana Dashboards](https://grafana.com/grafana/dashboards/) بروید.
2. داشبورد مورد نظر خود را جستجو کنید:
   - از نوار جستجو برای یافتن داشبورد مرتبط با منبع داده خود (مثلاً "Prometheus" یا "MySQL") استفاده کنید.
   - فیلترهای موجود (مانند نوع منبع داده یا دسته‌بندی) را برای محدود کردن نتایج اعمال کنید.
3. داشبورد مناسب را انتخاب کنید. هر داشبورد یک **ID** منحصربه‌فرد دارد (مثلاً `1860` برای داشبورد Node Exporter Full).
4. اطلاعات داشبورد را بررسی کنید:
   - مطمئن شوید که داشبورد با نسخه گرافانا و منبع داده شما سازگار است.
   - پیش‌نیازهای داشبورد (مانند نصب پلاگین یا تنظیمات خاص) را مطالعه کنید.



### **مرحله ۲: دانلود یا کپی JSON داشبورد**
برای استفاده از داشبورد، باید فایل JSON آن را دریافت کنید یا ID داشبورد را کپی کنید.

### **گزینه ۱: استفاده از ID داشبورد**
1. در صفحه داشبورد در وب‌سایت گرافانا، **ID داشبورد** (مثلاً `1860`) را یادداشت کنید.
2. در گرافانا، به مرحله بعدی (وارد کردن داشبورد) بروید.

### **گزینه ۲: دانلود فایل JSON**
1. در صفحه داشبورد، روی دکمه **Download JSON** کلیک کنید.
2. فایل JSON را در سیستم خود ذخیره کنید (مثلاً `dashboard.json`).


### **مرحله ۳: وارد کردن داشبورد به گرافانا**
برای وارد کردن داشبورد آماده به گرافانا، یکی از روش‌های زیر را دنبال کنید:

#### **روش ۱: وارد کردن با ID داشبورد**
1. به رابط کاربری گرافانا (مثلاً `http://localhost:3000`) بروید و وارد شوید.
2. از منوی سمت چپ، روی آیکون **Dashboards** (نماد چهار مربع) کلیک کنید.
3. گزینه **Import** را انتخاب کنید.
4. در فیلد **Import via grafana.com**، **ID داشبورد** (مثلاً `1860`) را وارد کنید.
5. روی **Load** کلیک کنید.
6. منبع داده (Data Source) مناسب را از لیست کشویی انتخاب کنید (مثلاً Prometheus).
7. در صورت نیاز، تنظیمات دیگر (مانند نام داشبورد یا متغیرها) را سفارشی کنید.
8. روی **Import** کلیک کنید تا داشبورد اضافه شود.

#### **روش ۲: وارد کردن با فایل JSON**
1. به رابط کاربری گرافانا بروید و وارد شوید.
2. از منوی سمت چپ، روی آیکون **Dashboards** کلیک کنید.
3. گزینه **Import** را انتخاب کنید.
4. در بخش **Import via file**، روی **Upload JSON file** کلیک کنید.
5. فایل JSON دانلودشده (مثلاً `dashboard.json`) را انتخاب کنید.
6. منبع داده مناسب را انتخاب کنید.
7. تنظیمات مورد نظر (مانند نام داشبورد) را اعمال کنید.
8. روی **Import** کلیک کنید.



### **مرحله ۴: بررسی و پیکربندی داشبورد**
پس از وارد کردن داشبورد، باید مطمئن شوید که به درستی کار می‌کند.

1. **بررسی نمایش داده‌ها**:
   - داشبورد را باز کنید و مطمئن شوید که نمودارها و پنل‌ها داده‌ها را به درستی نمایش می‌دهند.
   - اگر داده‌ای نمایش داده نشد، بررسی کنید که منبع داده به درستی پیکربندی شده باشد.
2. **تنظیم متغیرها (Variables)**:
   - بسیاری از داشبوردهای آماده از متغیرها (مانند انتخاب سرور یا بازه زمانی) استفاده می‌کنند.
   - در بالای داشبورد، متغیرها را بررسی و مقادیر مناسب (مانند نام سرور یا نود) را تنظیم کنید.
3. **رفع خطاها**:
   - اگر پنل‌ها خطا می‌دهند (مثلاً "No Data")، مطمئن شوید که منبع داده شما داده‌های مورد نیاز داشبورد را فراهم می‌کند.
   - برای داشبوردهای Prometheus، بررسی کنید که متریک‌ها (مانند `node_cpu_seconds_total`) در سرور Prometheus موجود باشند.

---

## 2. روش شخصی سازی شده
در منوی **Dashboards**، گزینه **New Dashboard** را انتخاب کنید. در ادامه، سه نوع پنل را ایجاد می‌کنیم:
**نمودار سری زمانی**، **گیج**، و **جدول**.

### ۱. پنل نمودار سری زمانی (Time Series)
این پنل برای نمایش تغییرات متریک‌ها در طول زمان مناسب است.

**مراحل:**
1. در داشبورد، روی **Add > Visualization** کلیک کنید و نوع پنل را **Time Series** انتخاب کنید.
2. بازه زمانی را به ۳۰ دقیقه تنظیم کنید (در منوی بالا).
3. یک کوئری PromQL وارد کنید. مثلاً:
```promql
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path, method))
```
   - این کوئری صدک ۹۵ (95th percentile) تأخیر درخواست‌های HTTP را برای هر مسیر (path) و متد (method) محاسبه می‌کند.
4. **تنظیمات پنل:**
   - **عنوان:** «تأخیر صدک ۹۵ درخواست‌ها»
   - **واحد:** در بخش Panel Options، واحد را به **Seconds** تنظیم کنید تا گرافانا مقادیر را به‌درستی (مثلاً در میلی‌ثانیه) نمایش دهد.
   - **فرمت لجند:** برای خواناتر شدن لجند، به بخش Query Options بروید و فرمت دلخواه را وارد کنید:
```
{{path}} - {{method}}
```
     این کار لجند را به‌صورت `path-method` (مثلاً `/api/get - GET`) نمایش می‌دهد.
5. روی **Apply** کلیک کنید تا پنل ذخیره شود.

**مثال عملی:**
فرض کنید وب‌سرویسی دارید که تأخیر درخواست‌ها را مانیتور می‌کنید. این پنل نشان می‌دهد که مسیر `/api/login` تأخیر بیشتری نسبت به `/api/status` دارد. می‌توانید از این اطلاعات برای شناسایی گلوگاه‌ها استفاده کنید.

### ۲. پنل گیج (Gauge)
این پنل برای نمایش یک مقدار لحظه‌ای (مثل درصد استفاده از CPU) مناسب است.

**مراحل:**
1. یک پنل جدید اضافه کنید و نوع آن را **Gauge** انتخاب کنید.
2. کوئری PromQL زیر را وارد کنید:
```promql
avg(rate(node_cpu_seconds_total{mode="user"}[5m]))
```
   - این کوئری میانگین استفاده از CPU در حالت کاربر (user mode) را برای چند نمونه محاسبه می‌کند.
3. **تنظیمات پنل:**
   - **عنوان:** «استفاده لحظه‌ای از CPU»
   - **واحد:** در بخش Panel Options، واحد را به **Percent (0.0-1.0)** تنظیم کنید.
   - **حداقل و حداکثر:** حداقل را ۰ و حداکثر را ۱ تنظیم کنید.
   - **آستانه‌ها (Thresholds):** آستانه قرمز را روی ۰.۸ (معادل ۸۰٪) تنظیم کنید تا استفاده بالای ۸۰٪ به رنگ قرمز نمایش داده شود.
4. روی **Apply** کلیک کنید.

**مثال عملی:**
اگر سرور شما سه نمونه (instance) دارد، این پنل استفاده CPU هر نمونه را به‌صورت گیج نشان می‌دهد. اگر گیج یکی از نمونه‌ها قرمز شود، می‌توانید سریعاً بررسی کنید که آیا سرور تحت فشار است یا خیر.

### ۳. پنل جدول (Table)
این پنل برای نمایش داده‌های لحظه‌ای به‌صورت جدولی مناسب است.

**مراحل:**
1. یک پنل جدید اضافه کنید و نوع آن را **Table** انتخاب کنید.
2. کوئری PromQL زیر را وارد کنید:
```promql
topk(3, sum(rate(http_requests_total[5m])) by (path, method))
```
   - این کوئری سه مسیر و متد با بالاترین نرخ درخواست را نشان می‌دهد.
3. **تنظیمات پنل:**
   - **فرمت:** در بخش Query Options، فرمت را به **Table** تغییر دهید.
   - **نوع کوئری:** نوع را به **Instant** تغییر دهید تا فقط آخرین مقدار هر سری زمانی نمایش داده شود.
   - **حذف ستون زمان:** دو روش وجود دارد:
     1. از بخش **Transform**، گزینه **Organize Fields** را انتخاب کنید و ستون زمان را مخفی کنید.
     2. از بخش **Field Options**، یک override برای فیلد نوع **Time** اضافه کنید و آن را مخفی کنید.
   - **واحد:** واحد را به **Requests/s** تنظیم کنید.
   - **عنوان:** «سه نرخ درخواست برتر»
4. روی **Apply** کلیک کنید.

**مثال عملی:**
این جدول نشان می‌دهد که مسیر `/api/get` با متد `GET` بالاترین نرخ درخواست را دارد. می‌توانید از این داده‌ها برای بهینه‌سازی مسیرهای پرترافیک استفاده کنید.

## سازمان‌دهی داشبورد با ردیف‌ها (Rows)

برای مرتب‌سازی پنل‌ها، می‌توانید آن‌ها را در ردیف‌های موضوعی گروه‌بندی کنید.

**مراحل:**
1. در داشبورد، روی **Add > Row** کلیک کنید و دو ردیف به نام‌های «آمار HTTP» و «آمار CPU» ایجاد کنید.
2. پنل‌ها را با drag-and-drop به ردیف مناسب منتقل کنید (مثلاً پنل‌های سری زمانی و جدول به «آمار HTTP» و گیج به «آمار CPU»).
3. برای ذخیره داشبورد، روی آیکون ذخیره کلیک کنید و نامی مثل «دمو داشبورد» انتخاب کنید.

**مثال عملی:**
با این سازمان‌دهی، داشبورد شما خواناتر می‌شود. مثلاً تیم شبکه می‌تواند روی ردیف «آمار HTTP» تمرکز کند، در حالی که تیم زیرساخت روی «آمار CPU» نظارت می‌کند.

## نکات کاربردی

1. **متغیرهای قالب گرافانا:** گرافانا از متغیرهایی مثل `$__rate_interval` پشتیبانی می‌کند که بازه مناسب برای کوئری‌های `rate` را به‌صورت خودکار تنظیم می‌کند.
```promql
rate(http_requests_total[$__rate_interval])
```
2. **هشدار در گرافانا:** می‌توانید هشدارهایی بر اساس کوئری‌های PromQL تنظیم کنید. مثلاً:
```promql
ALERT HighCPULoad
IF avg(rate(node_cpu_seconds_total{mode="user"}[5m])) > 0.8
FOR 5m
LABELS { severity = "warning" }
ANNOTATIONS {
summary = "بار CPU بالا",
description = "استفاده CPU در {{ $labels.instance }} بیش از ۸۰٪ است."
}
 ```
3. **بهینه‌سازی کوئری‌ها:** از توابع `sum`، `avg`، و `topk` برای کاهش تعداد سری‌های زمانی در داشبورد استفاده کنید تا عملکرد بهبود یابد.
4. **ذخیره‌سازی دائمی:** اگر از داکر استفاده می‌کنید، حتماً از ولوم برای ذخیره دائمی داشبوردها استفاده کنید.

## مثال جامع: داشبورد مانیتورینگ وب‌سرویس
فرض کنید یک وب‌سرویس دارید که می‌خواهید متریک‌های زیر را مانیتور کنید:
- **تأخیر درخواست‌ها:** صدک ۹۵ تأخیر برای هر مسیر.
- **نرخ درخواست‌ها:** سه مسیر پرترافیک.
- **استفاده CPU:** درصد استفاده CPU برای هر نمونه.

**داشبورد پیشنهادی:**
- **ردیف HTTP Stats:**
  - پنل سری زمانی: `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path))`
  - پنل جدول: `topk(3, sum(rate(http_requests_total[5m])) by (path))`
- **ردیف CPU Stats:**
  - پنل گیج: `avg(rate(node_cpu_seconds_total{mode="user"}[5m]))`

این داشبورد به شما دید کلی از عملکرد وب‌سرویس و سلامت سرورها می‌دهد.

## جمع‌بندی
گرافانا ابزاری قدرتمند برای بصری‌سازی داده‌های پرومتئوس است. با نصب گرافانا، اتصال آن به پرومتئوس، و ایجاد پنل‌های سری زمانی، گیج، و جدول، می‌توانید داشبوردهایی بسازید که اطلاعات کلیدی سیستم را به‌صورت واضح نمایش دهند. سازمان‌دهی پنل‌ها در ردیف‌ها و استفاده از متغیرهای گرافانا، کارایی داشبورد را افزایش می‌دهد. برای یادگیری عمیق‌تر، به دوره‌های آموزشی پرومتئوس و گرافانا مراجعه کنید یا سوالات خود را در بخش نظرات مطرح کنید!
