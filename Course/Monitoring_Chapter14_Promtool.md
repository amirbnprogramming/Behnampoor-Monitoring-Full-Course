آموزش مانیتورینگ: قسمت چهاردهم   Promtool در پرومتئوس

## مقدمه
در این بخش از آموزش‌های پرومتئوس، به بررسی ابزار **Promtool** می‌پردازیم. این ابزار یکی از اجزای کلیدی پرومتئوس است که برای مدیریت، اعتبارسنجی و دیباگ کردن پیکربندی‌ها و قوانین پرومتئوس استفاده می‌شود. اگر با پرومتئوس کار کرده باشید، احتمالاً می‌دانید که پیکربندی درست و بدون خطا برای عملکرد صحیح این سیستم مانیتورینگ حیاتی است. Promtool به شما کمک می‌کند تا این فرآیند را ساده‌تر و مطمئن‌تر انجام دهید.

در این مقاله، به فلسفه وجود Promtool، کاربردهای آن و چند مثال کاربردی ساده و روان می‌پردازیم. هدف این است که به زبان ساده و قابل فهم، این ابزار را معرفی کنیم و شما را با نحوه استفاده از آن آشنا کنیم.

## فلسفه وجود Promtool
ابزار Promtool به‌عنوان یک ابزار خط فرمان (Command-Line Tool) در اکوسیستم پرومتئوس طراحی شده است تا وظایف زیر را انجام دهد:
1. **اعتبارسنجی پیکربندی‌ها**: اطمینان از صحت فایل‌های پیکربندی پرومتئوس (مانند `prometheus.yml`) و قوانین هشدار (Alert Rules).
2. **دیباگ و تست**: کمک به توسعه‌دهندگان و مدیران سیستم برای بررسی مشکلات احتمالی در تنظیمات یا کوئری‌های PromQL.
3. **مدیریت داده‌ها**: انجام کارهایی مثل بررسی سری‌های زمانی، پاک‌سازی داده‌ها یا حتی کار با اسنپ‌شات‌های پایگاه داده پرومتئوس.
4. **اتوماسیون و بهینه‌سازی**: فراهم کردن امکاناتی برای خودکارسازی فرآیندهای مرتبط با پرومتئوس، مثل بررسی قوانین یا تست کوئری‌ها.

**به‌طور خلاصه**
- سرویس Promtool مانند یک "جعبه‌ابزار" برای پرومتئوس عمل می‌کند که به شما کمک می‌کند از صحت عملکرد سیستم مطمئن شوید و مشکلات را قبل از وقوع شناسایی کنید.

## ابزار Promtool چیکار می‌کند؟
ابزار Promtool مجموعه‌ای از دستورات را ارائه می‌دهد که هر کدام برای هدف خاصی طراحی شده‌اند. برخی از مهم‌ترین کاربردهای آن عبارتند از:

- **بررسی فایل‌های پیکربندی**: با استفاده از دستور `check`, می‌توانید مطمئن شوید که فایل `prometheus.yml` یا فایل‌های قوانین (Rule Files) از نظر ساختاری و منطقی درست هستند.
- **تست قوانین هشدار**: می‌توانید قوانین هشدار (Alert Rules) را قبل از اعمال در محیط واقعی تست کنید.
- **کار با سری‌های زمانی**: امکان مشاهده، بررسی یا حتی حذف سری‌های زمانی از پایگاه داده پرومتئوس.
- **دیباگ کوئری‌های PromQL**: بررسی کوئری‌ها برای اطمینان از صحت آن‌ها و بهینه‌سازی عملکرد.
- **ایجاد اسنپ‌شات**: گرفتن نسخه پشتیبان از داده‌های پرومتئوس برای استفاده‌های بعدی.

## پیش‌نیازها
برای استفاده از Promtool، باید:
1. پرومتئوس را روی سیستم خود نصب کرده باشید (فایل باینری Promtool معمولاً همراه با نصب پرومتئوس ارائه می‌شود).
2. دسترسی به فایل‌های پیکربندی پرومتئوس (مانند `prometheus.yml`) داشته باشید.
3. با مفاهیم اولیه پرومتئوس مثل سری‌های زمانی (Time Series) و PromQL آشنا باشید.

## نصب Promtool
فایل باینری Promtool به‌صورت پیش‌فرض همراه با بسته پرومتئوس نصب می‌شود. برای اطمینان از نصب آن، می‌توانید دستور زیر را اجرا کنید:
```bash
promtool --version
```
اگر نسخه Promtool نمایش داده شد، آماده استفاده است. در غیر این صورت، می‌توانید پرومتئوس را از [مخزن رسمی GitHub](https://github.com/prometheus/prometheus/releases) دانلود و نصب کنید.

## مثال‌های کاربردی ساده و روان
در ادامه، چند مثال کاربردی و ساده از Promtool را با توضیحات کامل ارائه می‌دهیم. این مثال‌ها به شما کمک می‌کنند تا با نحوه کار این ابزار آشنا شوید.

### 1. بررسی صحت فایل پیکربندی پرومتئوس
یکی از رایج‌ترین کاربردهای Promtool، بررسی فایل پیکربندی `prometheus.yml` است. این کار از خطاهای احتمالی در پیکربندی جلوگیری می‌کند.

**دستور:**
```bash
promtool check config prometheus.yml
```

**توضیح:**
این دستور فایل `prometheus.yml` را از نظر ساختاری و منطقی بررسی می‌کند. اگر فایل مشکلی نداشته باشد، پیغام `SUCCESS` نمایش داده می‌شود. در غیر این صورت، خطاها و هشدارهای احتمالی گزارش می‌شوند.

**مثال عملی:**
فرض کنید فایل `prometheus.yml` شما به این شکل است:
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'node'
    static_configs:
      - targets: ['localhost:9100']
```

با اجرای دستور زیر:
```bash
promtool check config prometheus.yml
```
خروجی احتمالی:
```
Checking prometheus.yml
SUCCESS: prometheus.yml is valid
```

اگر فایل مشکلی داشته باشد، مثلاً یک خطای نگارشی (Syntax Error) وجود داشته باشد، خروجی چیزی شبیه به این خواهد بود:
```
Checking prometheus.yml
ERROR: prometheus.yml:3: invalid character at end of key
```

**کاربرد:**
این دستور قبل از راه‌اندازی یا ری‌استارت سرور پرومتئوس بسیار مفید است تا مطمئن شوید که پیکربندی شما بدون خطاست.

### 2. بررسی فایل قوانین هشدار
اگر از قوانین هشدار (Alert Rules) در پرومتئوس استفاده می‌کنید، می‌توانید با Promtool آن‌ها را بررسی کنید.

**دستور:**
```bash
promtool check rules rules.yml
```

**مثال عملی:**
فرض کنید فایل `rules.yml` شما به این شکل است:
```yaml
groups:
- name: example
  rules:
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High CPU usage detected on {{ $labels.instance }}"
```

با اجرای دستور:
```bash
promtool check rules rules.yml
```
خروجی احتمالی:
```
Checking rules.yml
SUCCESS: rules.yml is valid
```

**توضیح:**
این دستور بررسی می‌کند که ساختار فایل قوانین درست باشد و کوئری‌های PromQL در آن معتبر باشند. اگر خطایی وجود داشته باشد، جزئیات آن نمایش داده می‌شود.

**کاربرد:**
قبل از اعمال قوانین جدید در پرومتئوس، این دستور به شما کمک می‌کند تا از درست بودن آن‌ها مطمئن شوید.

### 3. تست کوئری PromQL
یکی دیگر از قابلیت‌های مفید Promtool، تست کوئری‌های PromQL است. این امکان به شما کمک می‌کند تا مطمئن شوید کوئری‌های شما نتایج مورد انتظار را تولید می‌کنند.

**دستور:**
```bash
promtool query instant http://localhost:9090 'up'
```

**توضیح:**
این دستور یک کوئری PromQL را به‌صورت آنی (Instant Query) اجرا می‌کند و نتیجه را نمایش می‌دهد. در اینجا، `up` یک متریک ساده است که وضعیت اهداف (Targets) را نشان می‌دهد.

**مثال عملی:**
فرض کنید سرور پرومتئوس شما روی `localhost:9090` در حال اجراست. با اجرای دستور زیر:
```bash
promtool query instant http://localhost:9090 'up'
```
خروجی ممکن است چیزی شبیه این باشد:
```
up{instance="localhost:9100",job="node"} 1
```
این خروجی نشان می‌دهد که هدف `localhost:9100` فعال و در دسترس است (مقدار `1` به معنای "Up" است).

**کاربرد:**
این دستور برای دیباگ کردن کوئری‌ها و بررسی سریع نتایج بسیار مفید است، به‌خصوص زمانی که می‌خواهید مطمئن شوید کوئری شما داده‌های درستی برمی‌گرداند.

### 4. بررسی سری‌های زمانی
سرویس Promtool می‌تواند سری‌های زمانی موجود در پایگاه داده پرومتئوس را بررسی کند.

**دستور:**
```bash
promtool tsdb list /path/to/prometheus/data
```

**توضیح:**
این دستور لیستی از سری‌های زمانی موجود در پایگاه داده پرومتئوس را نمایش می‌دهد. مسیر `/path/to/prometheus/data` باید به دایرکتوری داده‌های پرومتئوس اشاره کند.

**مثال عملی:**
اگر دایرکتوری داده‌های پرومتئوس شما در `/var/lib/prometheus` باشد، دستور زیر را اجرا کنید:
```bash
promtool tsdb list /var/lib/prometheus
```
خروجی ممکن است لیستی از متریک‌ها و برچسب‌های آن‌ها را نشان دهد، مثل:
```
{__name__="up", instance="localhost:9100", job="node"}
{__name__="node_cpu_seconds_total", instance="localhost:9100", job="node", mode="idle"}
```

**کاربرد:**
این دستور برای بررسی محتوای پایگاه داده پرومتئوس و شناسایی متریک‌های ذخیره‌شده مفید است.

## نکات مهم در استفاده از Promtool
1. **دسترسی به سرور پرومتئوس**: برای دستوراتی مثل `query instant`، سرور پرومتئوس باید در دسترس باشد.
2. **به‌روزرسانی Promtool**: مطمئن شوید که نسخه Promtool با نسخه پرومتئوس شما سازگار است.
3. **ذخیره‌سازی خروجی**: می‌توانید خروجی دستورات Promtool را با استفاده از `>` به فایل ذخیره کنید، مثلاً:
   ```bash
   promtool check config prometheus.yml > check_result.txt
   ```
4. **خوانایی خطاها**: Promtool معمولاً خطاها را با جزئیات خوبی نمایش می‌دهد. به این جزئیات توجه کنید تا مشکلات را سریع‌تر برطرف کنید.

## جمع‌بندی
سرویس Promtool یک ابزار قدرتمند و ضروری در اکوسیستم پرومتئوس است که به شما کمک می‌کند پیکربندی‌ها و قوانین را بررسی کنید، کوئری‌ها را تست کنید و مشکلات را شناسایی کنید.
با استفاده از دستورات ساده‌ای که در این مقاله معرفی شد، می‌توانید از صحت پیکربندی‌های خود مطمئن شوید و فرآیند مانیتورینگ را بهبود دهید.

اگر تازه‌کار هستید، پیشنهاد می‌کنیم با دستورات ساده مثل `check config` شروع کنید و به‌تدریج با قابلیت‌های پیشرفته‌تر Promtool آشنا شوید.
این ابزار مانند یک دستیار وفادار، همیشه در کنار شماست تا سیستم مانیتورینگ شما بدون نقص کار کند!
