# آموزش پرومتئوس - قسمت پنجم: نرخ‌های افزایش کانترها

در این قسمت از سری آموزش‌های پرومتئوس، به بررسی عمیق توابع مربوط به محاسبه نرخ افزایش (rate of increase) کانترها در PromQL می‌پردازیم. هدف این است که به شما درک کاملی از نحوه عملکرد توابع `rate`، `irate` و `increase` بدهیم، نحوه برخورد آن‌ها با موارد خاص (edge cases) را توضیح دهیم و توصیه‌های کاربردی برای استفاده از آن‌ها ارائه کنیم. این آموزش با مثال‌های عملی و توضیحات عمیق همراه خواهد بود تا مفاهیم به شکلی شفاف و قابل‌فهم ارائه شوند.

## چرا به نرخ افزایش کانترها نیاز داریم؟
کانترها (Counter Metrics) در پرومتئوس معیارهایی هستند که همیشه به‌صورت افزایشی عمل می‌کنند و به‌جز در مواقع ریست (مثلاً هنگام ری‌استارت شدن یک پروسه)، مقدارشان فقط افزایش می‌یابد. به همین دلیل، مقدار خام (absolute value) یک کانتر به‌تنهایی اطلاعات مفیدی درباره وضعیت فعلی سیستم ارائه نمی‌دهد، زیرا این مقدار به زمان شروع کانتر و تعداد افزایش‌های آن وابسته است.

> چون به زبان ساده اینا همش در حال افزایش هستند و یا ریست شدن ، بخاطر همین اینکه بیایم بگیرم متریک کانتری فلان در سری زمانی فلان زمان مشخص مقدار فلان را دارد هیچ چیزی به ما نشون نمیده و قابل تحلیل نیست بلکه رشد و سرعت رشد این متریک ها اهمیت دارد ، شیب نمودار هاشون مهمه !

آنچه در عمل برای ما مهم است، **نرخ افزایش** (rate of increase) کانتر در یک بازه زمانی مشخص است.

برای مثال:
- می‌خواهیم بدانیم نرخ درخواست‌های HTTP (requests per second) در یک سرویس چقدر است.
- یا مثلاً نرخ مجموع زمان مصرفی ارسال درخواست های HTTP چقدر است.

برای محاسبه این نرخ‌ها، پرومتئوس سه تابع اصلی ارائه می‌دهد:

- `تابع rate`
- `تاریع irate`
- `تابع increase`

در ادامه، هر یک از این توابع را به‌صورت عمیق بررسی می‌کنیم و تفاوت‌هایشان را با مثال توضیح می‌دهیم.

---
## معرفی سه تابع محاسبه نرخ افزایش

### ۱. تابع `rate`
تابع `rate` نرخ افزایش یک کانتر را به‌صورت **میانگین در ثانیه** (per-second average) در یک بازه زمانی مشخص (range window) محاسبه می‌کند.
این تابع تمام نمونه‌های (samples) موجود در بازه زمانی ورودی را در نظر می‌گیرد و یک خروجی صاف و هموار ارائه می‌دهد.

### میاد مجموع افزایش هارا تقسیم میکند بر    زمان بازه مدنظر
rate = (increase)/(Time)

#### اگر هم counter reset در بازه مدنظر باشد به شکل زیر آنهارا احیا میکند و بعد نرخ را محاسبه میکند.


<img width="2084" height="1250" alt="Screenshot 2025-07-18 104102" src="https://github.com/user-attachments/assets/10de5fe2-f5b9-4a4e-93b8-7cf50cd78144" />

<img width="2084" height="1250" alt="Screenshot 2025-07-18 104244" src="https://github.com/user-attachments/assets/c2f52d58-1490-418a-889a-4f46a2e06b55" />

<img width="2084" height="1250" alt="Screenshot 2025-07-18 104155" src="https://github.com/user-attachments/assets/7fc833e1-2cc4-4aa9-b3bb-11891a5ac544" />

<img width="2084" height="1250" alt="Screenshot 2025-07-18 104402" src="https://github.com/user-attachments/assets/78d3293e-83e7-4811-9709-043daae0344b" />



**ویژگی‌ها:**
- خروجی: نرخ افزایش به‌صورت افزایش در ثانیه.
- هموارسازی: میانگین نرخ افزایش در کل بازه زمانی.
- کاربرد: مناسب برای تحلیل‌های کلی و نمودارهایی که نیاز به نمایش روندهای پایدار دارند.


---
### ۲. تابع `irate`
تابع `irate` (مخفف instantaneous rate) نرخ افزایش را به‌صورت **لحظه‌ای** و با استفاده از **دو نمونه آخر** در بازه زمانی ورودی محاسبه می‌کند. این تابع بسیار سریع به تغییرات واکنش نشان می‌دهد و خروجی آن پرنوسان‌تر است.

**ویژگی‌ها:**
- خروجی: نرخ افزایش به‌صورت افزایش در ثانیه.
- هموارسازی: بدون هموارسازی، فقط دو نمونه آخر بررسی می‌شوند.
- کاربرد: مناسب برای نمودارهای زوم‌شده که تغییرات لحظه‌ای سیستم را نشان می‌دهند.

### ۳. تابع `increase`
تابع `increase` مشابه `rate` عمل می‌کند، اما به‌جای نرخ افزایش در ثانیه، **مقدار کل افزایش** (total increase) کانتر در بازه زمانی مشخص را برمی‌گرداند.

**ویژگی‌ها:**
- خروجی: مقدار کل افزایش در بازه زمانی.
- هموارسازی: مشابه `rate`، میانگین افزایش در کل بازه زمانی.
- کاربرد: مناسب برای زمانی که نیاز به مقدار مطلق افزایش (مانند تعداد کل درخواست‌ها) دارید.

**نکته مشترک:** هر سه تابع برای محاسبه نرخ یا افزایش، حداقل به **دو نمونه** در بازه زمانی ورودی نیاز دارند. اگر بازه زمانی شما به اندازه کافی بزرگ نباشد، ممکن است سری زمانی از نتیجه حذف شود.

## نحوه برخورد با ریست‌های کانتر

یکی از چالش‌های کار با کانترها، **ریست شدن** آن‌ها (مثلاً هنگام ری‌استارت شدن یک پروسه) است. وقتی یک کانتر ریست می‌شود، مقدار آن به صفر برمی‌گردد، که می‌تواند باعث محاسبات نادرست (مانند نرخ منفی) شود. پرومتئوس برای حل این مشکل، روش زیر را استفاده می‌کند:

1. **تشخیص ریست:** تابع ابتدا تمام نمونه‌ها را اسکن می‌کند و هر نمونه‌ای که مقدارش از نمونه قبلی کمتر باشد را به‌عنوان ریست شناسایی می‌کند.
2. **جبران ریست:** برای جبران، مقدار نمونه‌های بعد از ریست را با افزودن مقدار نمونه قبل از ریست اصلاح می‌کند. این کار باعث می‌شود سری زمانی اصلاح‌شده‌ای (reset-corrected) به دست آید.

**مثال:**
فرض کنید کانتری داریم که مقادیر آن به‌صورت زیر است (در یک بازه ۵ دقیقه‌ای):

```
t=0: 100
t=1: 150
t=2: 0 (ریست)
t=3: 50
t=4: 80
```

پرومتئوس تشخیص می‌دهد که در `t=2` یک ریست رخ داده است. برای اصلاح:
- مقدار نمونه‌های بعد از ریست (50 و 80) را با مقدار قبل از ریست (150) جمع می‌کند.
- سری اصلاح‌شده: `[100, 150, 150, 200, 230]`

این سری اصلاح‌شده برای محاسبات بعدی استفاده می‌شود.

**محدودیت:** اگر افزایش‌هایی درست قبل از ریست رخ داده باشند اما هنوز اسکرپ نشده باشند، این افزایش‌ها از دست می‌روند. برای کاهش این مشکل، اطمینان حاصل کنید که ریست‌ها به‌ندرت رخ می‌دهند و فاصله اسکرپ (scrape interval) کوتاه است.

## محاسبه نرخ و افزایش در توابع `rate` و `increase`

پس از اصلاح ریست‌ها، توابع `rate` و `increase` فقط به **اولین و آخرین نمونه** در بازه زمانی نگاه می‌کنند و شیب (slope) بین این دوავ

System: دو نمونه را محاسبه می‌کنند. این شیب نشان‌دهنده میانگین نرخ افزایش در بازه زمانی است.

### محاسبه شیب در `rate`
تابع `rate` شیب بین اولین و آخرین نمونه را محاسبه کرده و آن را به‌عنوان نرخ افزایش در ثانیه برمی‌گرداند.

**مثال:**
فرض کنید کانتر زیر را داریم:

```
t=0: 100
t=5: 200
```

در بازه ۵ دقیقه‌ای:
- شیب = (200 - 100) / (5 * 60) = 0.333 افزایش در ثانیه
- خروجی `rate`: 0.333

### محاسبه شیب در `increase`
تابع `increase` نیز شیب را مشابه `rate` محاسبه می‌کند، اما به‌جای نرخ در ثانیه، مقدار کل افزایش را برمی‌گرداند. مشکل اینجاست که نمونه‌ها معمولاً دقیقاً در ابتدا و انتهای بازه زمانی قرار ندارند (مثلاً فاصله نمونه‌ها ممکن است ۴.۵ دقیقه باشد، نه ۵ دقیقه). برای حل این مشکل، `increase` شیب را به مرزهای بازه زمانی **اکستراپوله** (extrapolate) می‌کند تا مقدار کل افزایش در ۵ دقیقه را تخمین بزند.

**مثال:**
برای همان کانتر بالا:
- شیب = (200 - 100) / (4.5 * 60) = 0.333 افزایش در ثانیه
- افزایش کل = 0.333 * (5 * 60) ≈ 100
- خروجی `increase`: 100

**نکته:** اکستراپولاسیون ممکن است برای کانترهای کند (slow-moving counters) که به‌ندرت افزایش می‌یابند، نتایج غیرمنتظره‌ای تولید کند. مثلاً اگر کانتر فقط یک افزایش در بازه داشته باشد، اما اکستراپولاسیون فاصله زیادی را پوشش دهد، ممکن است نتیجه غیرصحیح به نظر برسد.

### محدودیت‌های اکستراپولاسیون
برای جلوگیری از نتایج نادرست در موارد خاص، `increase` دو محدودیت اعمال می‌کند:
1. **شروع یا پایان سری در بازه:** اگر سری زمانی در وسط بازه شروع یا تمام شود، اکستراپولاسیون فقط تا نصف فاصله متوسط نمونه‌ها انجام می‌شود.
2. **مقادیر منفی:** اگر اکستراپولاسیون منجر به مقدار منفی شود (که برای کانترها بی‌معنی است)، اکستراپولاسیون در مقدار صفر قطع می‌شود.

## تابع `irate`
تابع `irate` نرخ افزایش لحظه‌ای را با استفاده از **دو نمونه آخر** در بازه محاسبه می‌کند. این تابع به کل بازه نگاه نمی‌کند و فقط به دو نمونه آخر وابسته است، بنابراین نتایج آن بسیار پرنوسان و حساس به تغییرات لحظه‌ای است.

**مثال:**
کانتر زیر را در نظر بگیرید:

```
t=0: 100
t=1: 110
t=2: 0 (ریست)
t=3: 20
t=4: 50
```

برای بازه ۵ دقیقه‌ای:
- دو نمونه آخر: t=3 (20) و t=4 (50)
- اصلاح ریست: 20 → 120 (با فرض مقدار قبل از ریست 100)
- نرخ = (50 - 20) / (1 * 60) = 0.5 افزایش در ثانیه
- خروجی `irate`: 0.5

**کاربرد:** `irate` برای نمودارهای زوم‌شده و مشاهده تغییرات سریع مناسب است، اما برای هشدارها (alerts) توصیه نمی‌شود، زیرا نیاز به هموارسازی در هشدارها وجود دارد.

## کدام تابع را استفاده کنیم؟
توصیه کلی: **از `rate` استفاده کنید** مگر اینکه دلیل خاصی برای استفاده از `irate` یا `increase` داشته باشید. دلایل:
- `rate` خروجی صاف و قابل‌پیش‌بینی ارائه می‌دهد.
- واحد خروجی آن (افزایش در ثانیه) مستقل از اندازه بازه زمانی است.
- برای ترکیب با سایر معیارها در PromQL مناسب‌تر است.

**موارد استفاده خاص:**
- از `irate` برای تحلیل تغییرات لحظه‌ای در نمودارهای زوم‌شده استفاده کنید.
- از `increase` برای محاسبه مقدار کل افزایش (مثلاً تعداد کل درخواست‌ها) استفاده کنید.

## نکات کاربردی
1. **اندازه بازه زمانی:** همیشه بازه زمانی را به اندازه‌ای بزرگ انتخاب کنید که حداقل دو نمونه را شامل شود. مثلاً اگر فاصله اسکرپ ۱۵ ثانیه است، بازه حداقل ۳۰ ثانیه باشد.
2. **فاصله اسکرپ:** فاصله اسکرپ کوتاه‌تر (مثلاً ۱۰-۱۵ ثانیه) به کاهش خطای ناشی از ریست‌ها کمک می‌کند.
3. **هشدارها:** برای هشدارها از `rate` با بازه زمانی بزرگ‌تر (مثلاً ۵ دقیقه) استفاده کنید تا از نوسانات لحظه‌ای جلوگیری شود.

**مثال کاربردی:**
فرض کنید یک سرویس وب دارید و می‌خواهید نرخ درخواست‌های HTTP را مانیتور کنید:
```promql
rate(http_requests_total[5m])
```
این دستور نرخ میانگین درخواست‌ها در ثانیه را در بازه ۵ دقیقه‌ای محاسبه می‌کند. برای هشدار، می‌توانید از شرط زیر استفاده کنید:
```promql
rate(http_requests_total[5m]) > 100
```
این هشدار فعال می‌شود اگر نرخ درخواست‌ها از ۱۰۰ درخواست در ثانیه بیشتر شود.

## جمع‌بندی
در این آموزش، با توابع `rate`، `irate` و `increase` در پرومتئوس آشنا شدیم. تابع `rate` برای تحلیل‌های کلی و هشدارها مناسب است، `irate` برای تغییرات لحظه‌ای و `increase` برای محاسبه مقدار کل افزایش. با درک نحوه برخورد این توابع با ریست‌ها و اکستراپولاسیون، می‌توانید معیارهای دقیق‌تری برای مانیتورینگ سیستم خود ایجاد کنید.

برای یادگیری بیشتر، می‌توانید به دوره‌های آموزشی پرومتئوس مراجعه کنید یا سوالات خود را در بخش نظرات مطرح کنید!
