# آموزش نمایش هیستوگرام‌های پرومتئوس به‌صورت هیت‌مپ در گرافانا

در این بخش، به‌عنوان آخرین قسمت از سری آموزش‌های پرومتئوس، به بررسی چگونگی نمایش هیستوگرام‌های پرومتئوس به‌صورت هیت‌مپ در گرافانا می‌پردازیم. این آموزش با تمرکز بر جزئیات فنی و کاربردی، به شما کمک می‌کند تا نه‌تنها این قابلیت را پیاده‌سازی کنید، بلکه درک عمیقی از مفاهیم و کاربردهای آن به دست آورید. همچنین، با مثال‌های عملی و نکات پیشرفته، تجربه‌ای جامع و کاربردی خواهید داشت.

## مقدمه: چرا هیت‌مپ برای هیستوگرام‌ها مهم است؟

هیت‌مپ‌ها ابزارهای بصری قدرتمندی هستند که توزیع داده‌ها را در بازه‌های مختلف به‌صورت گرافیکی نمایش می‌دهند. در پرومتئوس، هیستوگرام‌ها برای اندازه‌گیری توزیع متریک‌ها (مانند تأخیر درخواست‌ها) استفاده می‌شوند و هیت‌مپ‌ها راهی عالی برای تجسم این توزیع‌ها در گرافانا هستند. هیت‌مپ‌ها به شما امکان می‌دهند تا به‌سرعت الگوهای عملکردی سرویس خود را شناسایی کنید، مانند شناسایی تأخیرهای غیرعادی یا خوشه‌های درخواست در بازه‌های زمانی خاص.

> **نکته پیشرفته**: هیت‌مپ‌ها به‌ویژه در سناریوهایی که نیاز به تحلیل سریع حجم بالای داده‌ها دارید (مانند مانیتورینگ سیستم‌های توزیع‌شده) بسیار مفید هستند. رنگ‌های روشن‌تر نشان‌دهنده تراکم بالاتر داده‌ها هستند، که به تحلیلگران کمک می‌کند تا به‌سرعت نقاط بحرانی را شناسایی کنند.

## پیش‌نیازها

قبل از شروع، فرض می‌کنیم که:
1. یک نمونه فعال از گرافانا (ترجیحاً نسخه 11.1.4 یا بالاتر) دارید.
2. با مفاهیم اولیه هیستوگرام‌های پرومتئوس آشنا هستید (در غیر این صورت، به آموزش‌های قبلی مراجعه کنید).
3. یک داشبورد گرافانا دارید و می‌دانید چگونه پنل‌های جدید ایجاد کنید.

اگر با این موارد آشنا نیستید، توصیه می‌کنیم ابتدا آموزش‌های مربوط به نصب و راه‌اندازی گرافانا و پرومتئوس را مطالعه کنید.

## گام ۱: ایجاد پنل هیت‌مپ در گرافانا

برای نمایش هیستوگرام پرومتئوس به‌صورت هیت‌مپ، ابتدا باید یک پنل جدید در گرافانا ایجاد کنیم.

   - **ایجاد پنل جدید**:
      - اگر داشبورد شما جدید است، روی گزینه **"Add Visualization"** کلیک کنید.
      - اگر داشبورد دارای پنل‌های دیگر است، از منوی بالا روی **"Add"** و سپس **"Visualization"** کلیک کنید.
   
   - **انتخاب نوع ویژوال‌سازی**:
      - در تنظیمات پنل (گوشه بالا سمت راست)، نوع ویژوال‌سازی را به **"Heatmap"** تغییر دهید.

> **نکته کاربردی**: انتخاب نوع "Heatmap" به گرافانا می‌گوید که داده‌ها باید به‌صورت یک ماتریس دوبعدی (زمان در محور x و بازه‌های هیستوگرام در محور y) نمایش داده شوند.

## گام ۲: نوشتن کوئری PromQL

برای نمایش هیستوگرام، باید یک کوئری PromQL بنویسیم که داده‌های هیستوگرام را از پرومتئوس استخراج کند. به‌عنوان مثال، فرض کنید متریکی به نام `http_request_duration_seconds` داریم که تأخیر درخواست‌های HTTP را در قالب هیستوگرام ذخیره می‌کند.

### مثال کوئری:
```promql
rate(http_request_duration_seconds_bucket[5m])
```

**توضیح کوئری**:
- `http_request_duration_seconds_bucket`: این متریک، تعداد درخواست‌ها را در بازه‌های مختلف تأخیر (buckets) ذخیره می‌کند.
- `rate(...[5m])`: نرخ درخواست‌ها در هر ثانیه را در بازه زمانی ۵ دقیقه محاسبه می‌کند.
- برچسب `le` در این متریک نشان‌دهنده حد بالای هر بازه (bucket) است.

> **نکته پیشرفته**: برای بهبود دقت، می‌توانید از تابع `histogram_quantile` برای محاسبه صدک‌ها (مانند p95 یا p99) استفاده کنید. مثلاً:
> ```promql
> histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
> ```
> این کوئری تأخیر صدک ۹۵ را محاسبه می‌کند، که برای تحلیل عملکرد سرویس بسیار مفید است.

## گام ۳: تنظیم فرمت داده‌ها

پس از اجرای کوئری، ممکن است هیت‌مپ به‌درستی نمایش داده نشود. دلیل آن، تنظیمات پیش‌فرض گرافانا است که فرض می‌کند داده‌های هیستوگرام غیرتجمعی هستند. برای رفع این مشکل:

1. در تنظیمات کوئری، گزینه **"Format"** را از **"Time Series"** به **"Heatmap"** تغییر دهید.
2. این تنظیم به گرافانا می‌گوید که داده‌ها به‌صورت تجمعی (cumulative) هستند و باید بر اساس برچسب `le` تفسیر شوند.

> **چرا این مهم است؟**  
> هیستوگرام‌های پرومتئوس به‌صورت پیش‌فرض داده‌های تجمعی را ذخیره می‌کنند (یعنی هر بازه شامل تمام درخواست‌های تا آن حد است). گرافانا باید این رفتار را به‌درستی تفسیر کند تا هیت‌مپ دقیق باشد.

## گام ۴: تنظیم واحد نمایش

برای خواناتر شدن محور y (که بازه‌های تأخیر را نشان می‌دهد):
1. به بخش **"Unit"** در تنظیمات پنل بروید.
2. واحد را به **"seconds"** تنظیم کنید، زیرا متریک ما تأخیر را بر حسب ثانیه اندازه‌گیری می‌کند.
3. این کار باعث می‌شود مقادیر محور y به‌صورت فرمت‌شده (مانند 0.1s، 1s، 10s) نمایش داده شوند.

> **مثال عملی**: اگر متریک شما تأخیر را بر حسب میلی‌ثانیه ذخیره کند، واحد را به **"milliseconds"** تنظیم کنید تا نمایش دقیق‌تری داشته باشید.

## گام ۵: نام‌گذاری و نهایی‌سازی پنل

1. برای پنل یک عنوان مناسب انتخاب کنید، مثلاً **"تأخیر سرویس دمو"**.
2. روی **"Apply"** کلیک کنید تا پنل به داشبورد اضافه شود.

## تفسیر هیت‌مپ

اکنون که هیت‌مپ شما آماده است، می‌توانید الگوهای تأخیر سرویس را به‌صورت بصری تحلیل کنید:
- **رنگ‌ها**: رنگ‌های روشن‌تر نشان‌دهنده تعداد بیشتری درخواست در آن بازه تأخیر هستند.
- **محور x**: نشان‌دهنده زمان است.
- **محور y**: بازه‌های تأخیر (بر اساس برچسب `le`) را نشان می‌دهد.

### مثال تفسیر:
- فرض کنید در یک بازه زمانی، رنگ روشنی در بازه 8.65 تا 13 میلی‌ثانیه مشاهده می‌کنید. این نشان می‌دهد که حدود ۱۰۰ درخواست در ثانیه در این بازه تأخیر داشته‌اید.
- در زمان دیگری، چند درخواست در بازه 333 تا 499 میلی‌ثانیه مشاهده می‌شوند، که ممکن است نشان‌دهنده یک مشکل عملکردی باشد.

> **نکته حرفه‌ای**: برای تحلیل دقیق‌تر، می‌توانید از قابلیت زوم گرافانا استفاده کنید یا بازه‌های زمانی خاصی را بررسی کنید. همچنین، افزودن هشدار (alert) برای بازه‌های تأخیر غیرعادی (مانند >500ms) می‌تواند به مانیتورینگ فعال کمک کند.

## نکات پیشرفته و کاربردی

1. **بهینه‌سازی کوئری‌ها**:
   - برای کاهش بار روی پرومتئوس، از بازه‌های زمانی مناسب (مانند `[5m]` یا `[10m]`) استفاده کنید.
   - اگر داده‌های زیادی دارید، از نمونه‌برداری (downsampling) با تابع `rate` یا `increase` استفاده کنید.

2. **شخصی‌سازی هیت‌مپ**:
   - می‌توانید رنگ‌های هیت‌مپ را در تنظیمات گرافانا تغییر دهید تا خواناتر شوند (مثلاً از گرادیان سبز به قرمز).
   - برای نمایش دقیق‌تر، می‌توانید تعداد بازه‌های محور y را افزایش دهید.

3. **ترکیب با سایر متریک‌ها**:
   - هیت‌مپ را با سایر پنل‌ها (مانند نمودار خطی برای نرخ خطا یا تعداد درخواست‌ها) ترکیب کنید تا دید جامعی از عملکرد سرویس داشته باشید.

4. **اتوماسیون و هشدار**:
   - از قابلیت‌های هشدار گرافانا برای اطلاع‌رسانی در صورت افزایش غیرعادی تأخیر استفاده کنید.
   - مثال: تنظیم هشدار برای زمانی که بیش از ۱۰ درخواست در ثانیه در بازه‌های تأخیر بالای ۵۰۰ میلی‌ثانیه رخ دهد.

## مثال واقعی: سناریوی مانیتورینگ یک API

فرض کنید یک API دارید که درخواست‌های کاربران را پردازش می‌کند. با استفاده از هیت‌مپ، می‌توانید:
- **شناسایی گلوگاه‌ها**: اگر تعداد زیادی درخواست در بازه‌های تأخیر بالا (مثلاً >1s) مشاهده شود، ممکن است نیاز به بهینه‌سازی کد یا افزایش منابع سرور باشد.
- **تحلیل الگوهای ترافیک**: مثلاً، اگر در ساعات خاصی (مانند ۸ صبح) تأخیر افزایش یابد، می‌توانید این الگو را با ترافیک کاربران مرتبط کنید.
- **مقایسه نسخه‌ها**: با مقایسه هیت‌مپ‌های قبل و بعد از به‌روزرسانی سرویس، می‌توانید تأثیر تغییرات را ارزیابی کنید.

## نتیجه‌گیری

نمایش هیستوگرام‌های پرومتئوس به‌صورت هیت‌مپ در گرافانا، ابزاری قدرتمند برای مانیتورینگ و تحلیل عملکرد سرویس‌ها است. با تنظیم درست کوئری‌ها، فرمت داده‌ها و واحدها، می‌توانید الگوهای تأخیر را به‌صورت بصری و قابل‌فهم مشاهده کنید. این ابزار به شما کمک می‌کند تا به‌سرعت مشکلات عملکردی را شناسایی کرده و اقدامات لازم را انجام دهید.

> **منابع بیشتر**: برای یادگیری عمیق‌تر، می‌توانید به دوره‌های آموزشی پرومتئوس در سایت‌هایی مانند [promlabs.com](https://promlabs.com) مراجعه کنید یا مستندات رسمی گرافانا و پرومتئوس را مطالعه کنید.
