# آموزش انتخاب داده‌ها در پرومتئوس با PromQL

در این بخش از آموزش پرومتئوس، به بررسی عمیق مفاهیم انتخاب داده‌ها در PromQL می‌پردازیم. انتخاب داده‌ها یکی از مهم‌ترین مراحل در کار با پرومتئوس است، زیرا برای انجام هرگونه تحلیل، محاسبه یا تبدیل داده‌ها، ابتدا باید داده‌های موردنظر خود را به‌درستی انتخاب کنیم. در این سند، دو نوع اصلی انتخابگرهای داده (selectors) یعنی **انتخابگرهای بردار لحظه‌ای (Instant Vector Selectors)** و **انتخابگرهای بردار بازه‌ای (Range Vector Selectors)**، همراه با جزئیات و اصلاح‌کننده‌های مرتبط مانند دلتای نگاه به عقب، مدیریت داده‌های منسوخ، آفست‌ها و زمان‌بندی‌های ارزیابی مطلق بررسی می‌شوند.

## انتخابگرهای بردار لحظه‌ای (Instant Vector Selectors)

انتخابگرهای بردار لحظه‌ای برای انتخاب آخرین مقدار یک سری زمانی (time series) نسبت به یک زمان‌بندی ارزیابی کلی استفاده می‌شوند. این نوع انتخابگرها برای نمایش یک نمونه (sample) برای هر سری زمانی در یک لحظه خاص مناسب هستند.

### نحوه کار
- **انتخاب ساده با نام متریک**: با نوشتن نام یک متریک (مانند `demo_memory_usage_bytes`)، می‌توانید آخرین نمونه از تمام سری‌های زمانی مرتبط با آن متریک را انتخاب کنید. خروجی شامل لیستی از سری‌های زمانی است که هر کدام یک نمونه دارند و همه به یک زمان‌بندی مشترک هم‌تراز شده‌اند.
  
#### مثال
```promql
demo_memory_usage_bytes
```
این پرس‌وجو تمام سری‌های زمانی با نام متریک `demo_memory_usage_bytes` را انتخاب کرده و آخرین نمونه هر سری را برمی‌گرداند، هم‌تراز با زمان‌بندی ارزیابی.

<img width="1243" height="729" alt="Screenshot 2025-07-17 132748" src="https://github.com/user-attachments/assets/00ae60a0-a0bd-4262-beb6-14f3a804510c" />

---

- **زمان‌بندی ارزیابی (Evaluation Timestamp)**: به‌طور پیش‌فرض، زمان‌بندی ارزیابی برابر با زمان فعلی مرورگر در رابط کاربری جدولی پرومتئوس است. اما می‌توانید این زمان‌بندی را به‌صورت دستی به یک زمان دلخواه در گذشته تنظیم کنید.
<img width="1252" height="731" alt="Screenshot 2025-07-17 132724" src="https://github.com/user-attachments/assets/db9f7634-bf0b-457b-b4f8-1339d8a0e674" />

---
  
- **حالت گرافیکی**: در حالت گرافیکی، انتخابگر بردار لحظه‌ای برای چندین زمان‌بندی متوالی در بازه زمانی گراف اجرا می‌شود. فاصله بین این زمان‌بندی‌ها به رزولوشن پرس‌وجو (query resolution) بستگی دارد. رزولوشن پیش‌فرض معمولاً بر اساس سطح زوم گراف تنظیم می‌شود، اما می‌توانید آن را به‌صورت دستی (مثلاً به 5 دقیقه) تغییر دهید تا مراحل جداگانه قابل‌مشاهده شوند.
  <img width="1237" height="1212" alt="Screenshot 2025-07-17 132643" src="https://github.com/user-attachments/assets/487a7778-492d-478c-8186-909411f310a6" />
  
---


### فیلتر کردن با تطبیق‌دهنده‌های برچسب (Label Matchers)

برای محدود کردن سری‌های زمانی بازگشتی، می‌توانید از تطبیق‌دهنده‌های برچسب استفاده کنید که در کروشه‌ها `{}` بعد از نام متریک قرار می‌گیرند. چهار نوع تطبیق‌دهنده برچسب وجود دارد:

1. **تطبیق برابر (`=`)**: فقط سری‌هایی را برمی‌گرداند که برچسب موردنظر دقیقاً مقدار مشخص‌شده را داشته باشد.
   ```promql
   demo_memory_usage_bytes{type="buffers"}
   ```

<img width="1247" height="445" alt="Screenshot 2025-07-17 133036" src="https://github.com/user-attachments/assets/8817fd39-cde4-418e-b2f7-1737947eee6e" />

   این پرس‌وجو فقط سری‌های زمانی را انتخاب می‌کند که برچسب `type` آنها برابر با `buffers` باشد.

---
1. **تطبیق نابرابر (`!=`)**: سری‌هایی را برمی‌گرداند که برچسب موردنظر مقدار مشخص‌شده را نداشته باشد.
   ```promql
   demo_memory_usage_bytes{type!="free"}
   ```

   <img width="1249" height="627" alt="Screenshot 2025-07-17 133050" src="https://github.com/user-attachments/assets/6e9cbd81-0ef6-4b17-bcec-57e16a3bf8cf" />


---
2. **تطبیق با عبارت منظم (`=~`)**: سری‌هایی را انتخاب می‌کند که مقدار برچسب آنها با یک عبارت منظم مطابقت داشته باشد.
   ```promql
   demo_memory_usage_bytes{type=~"buffers|cached"}
   ```

   <img width="1250" height="596" alt="Screenshot 2025-07-17 133136" src="https://github.com/user-attachments/assets/2b75c6ec-7ea6-4f9d-812b-391805e1b973" />


---
3. **تطبیق منفی با عبارت منظم (`!~`)**: سری‌هایی را انتخاب می‌کند که مقدار برچسب آنها با عبارت منظم مطابقت نداشته باشد.
   ```promql
   demo_memory_usage_bytes{type!~"buffers|cached"}
   ```

   <img width="1252" height="590" alt="Screenshot 2025-07-17 133150" src="https://github.com/user-attachments/assets/aa620157-cebd-43e1-b769-299a7a3da610" />


> **نکته**: عبارات منظم در PromQL به‌صورت پیش‌فرض به تطبیق کامل رشته نیاز دارند. برای تطبیق بخشی از مقدار برچسب، باید از کاراکترهای `.` و `*` در ابتدا و انتهای عبارت منظم استفاده کنید (مثال: `.*value.*`).

#### ترکیب تطبیق‌دهنده‌ها
می‌توانید چندین تطبیق‌دهنده را با کاما ترکیب کنید. در این صورت، همه شرایط باید برای بازگشت یک سری زمانی برقرار باشند.
```promql
demo_memory_usage_bytes{type="buffers", instance="instance1"}
```
---

## رفتار انتخابگرهای بردار لحظه‌ای

### دلتای نگاه به عقب (Lookback Delta)
دلتای نگاه به عقب (Lookback Delta) در پرومتئوس یه بازه زمانی پیش‌فرضه (معمولاً ۵ دقیقه) که سیستم برای پیدا کردن آخرین نمونه داده از یه سری زمانی به عقب نگاه می‌کنه. این تنظیم از نیاز به به‌روزرسانی‌های مداوم (مثلاً هر چند ثانیه) جلوگیری می‌کند و در عین حال سری‌های زمانی منسوخ (مانند سری‌هایی که یک روز پیش متوقف شده‌اند) را حذف می‌کند.
> به زبان ساده، وقتی یه پرس‌وجو (مثل انتخابگر بردار لحظه‌ای) اجرا می‌کنی، پرومتئوس نمی‌ره داده‌های خیلی قدیمی رو بیاره، بلکه فقط توی این بازه ۵ دقیقه‌ای دنبال آخرین داده می‌گرده. اگه تو این ۵ دقیقه داده‌ای پیدا نکنه، اون سری زمانی رو تو خروجی نشون نمی‌ده. این کار باعث می‌شه داده‌های منسوخ یا خیلی قدیمی توی نتایج نیان و در عین حال نیازی نباشه هر لحظه داده جدید داشته باشی.

- اگر سری زمانی در این بازه 5 دقیقه‌ای نمونه‌ای نداشته باشد، از خروجی حذف می‌شود.
- این تنظیم در سطح سرور با پرچم `--query.lookback-delta` قابل‌تغییر است، اما تغییر آن معمولاً توصیه نمی‌شود.

#### مثال
فرض کنید سری زمانی `demo_memory_usage_bytes` دارید:
```promql
demo_memory_usage_bytes
```
اگر زمان‌بندی ارزیابی فعلی باشد و نمونه‌ای در 5 دقیقه گذشته وجود نداشته باشد، آن سری زمانی در خروجی ظاهر نمی‌شود.

<img width="2440" height="1288" alt="Screenshot 2025-07-17 134312" src="https://github.com/user-attachments/assets/9d11c997-426b-49b4-b0e7-9bae6f0ea539" />

---

### مدیریت داده‌های منسوخ (Staleness Handling)

پرومتئوس می‌تواند تشخیص دهد که یک سری زمانی در زمان خاصی متوقف شده است (مثلاً وقتی یک هدف دیگر در اسکریپ بعدی گزارش نشود یا هدف کاملاً غیبش بزند).
در این موارد، یک **علامت منسوخ بودن (staleness marker)** در پایگاه داده زمانی (TSDB) ثبت می‌شود.

مدیریت داده‌های منسوخ در پرومتئوس به این معنیه که وقتی یه سری زمانی دیگه فعال نیست (مثلاً چون سرور خاموش شده یا داده‌ای تولید نمی‌کنه)، پرومتئوس اینو تشخیص می‌ده و اون سری زمانی رو از نتایج حذف می‌کنه. برای این کار، پرومتئوس یه علامت منسوخ بودن (staleness marker) ثبت می‌کنه که نشون می‌ده یه سری زمانی تموم شده. 

#### مثلاً:

- اگه یه سرور تو اسکریپ قبلی داده فرستاده باشه ولی تو اسکریپ بعدی چیزی نفرسته.
- یا اگه یه هدف (target) کامل غیبش بزنه یا اسکریپش با خطا مواجه بشه.


> وقتی این علامت ثبت می‌شه، انتخابگر بردار لحظه‌ای (Instant Vector Selector) دیگه اون سری زمانی رو تو خروجی نشون نمی‌ده، حتی اگه داده‌های قدیمی‌تر در بازه 5 دقیقه‌ای وجود داشته باشند یعنی حتی در loopback delta  هم باشد بازم نمایش نمیدهد . اگه بعداً همون سری زمانی دوباره فعال بشه (داده جدید بفرسته)، دوباره تو نتایج ظاهر می‌شه.

- انتخابگر بردار لحظه‌ای سری‌هایی را که آخرین نمونه آنها علامت منسوخ بودن است، فوراً از خروجی حذف می‌کند، حتی اگر نمونه‌های دیگری 
- اگر سری زمانی بعداً دوباره ظاهر شود، در نتایج بعدی دوباره نمایش داده خواهد شد.

 منسوخ شدن :

<img width="2400" height="1228" alt="Screenshot 2025-07-17 134708" src="https://github.com/user-attachments/assets/22891cf4-d851-4942-9eaf-eb72ec28585a" />


 ظاهر شدن مجدد در بازه :

<img width="2401" height="1264" alt="Screenshot 2025-07-17 134747" src="https://github.com/user-attachments/assets/4f7898f4-9fd6-4cc8-ae05-a9e4f2c1f1e8" />

---

## انتخابگرهای بردار بازه‌ای (Range Vector Selectors)

انتخابگرهای بردار بازه‌ای برای انتخاب چندین نمونه از سری‌های زمانی در یک بازه زمانی مشخص استفاده می‌شوند. این انتخابگرها معمولاً برای توابعی مانند `rate()` یا `deriv()` استفاده می‌شوند که داده‌های چند نمونه‌ای را به یک مقدار واحد تبدیل می‌کنند.

### نحوه کار
برای تبدیل یک انتخابگر بردار لحظه‌ای به بردار بازه‌ای، یک بازه زمانی در کروشه‌ها `[]` به انتهای انتخابگر اضافه می‌شود. این بازه زمانی تمام نمونه‌های موجود در دوره گذشته نسبت به زمان‌بندی ارزیابی را برمی‌گرداند.

#### مثال
```promql
demo_memory_usage_bytes[1m]
```

<img width="1236" height="727" alt="image" src="https://github.com/user-attachments/assets/ab083a66-e756-4251-9e07-2e3820959a86" />

این پرس‌وجو تمام نمونه‌های سری‌های زمانی `demo_memory_usage_bytes` را در بازه یک دقیقه گذشته برمی‌گرداند. اگر پرومتئوس هر 15 ثانیه اسکریپ کند، حدود 4 نمونه برای هر سری زمانی بازگردانده می‌شود.


> **توجه**: نتایج بردار بازه‌ای نمی‌توانند مستقیماً در گراف نمایش داده شوند، زیرا چندین نمونه برای هر سری در هر مرحله رزولوشن تولید می‌کنند. برای نمایش، باید از توابعی مانند `rate()` استفاده کنید:
```promql
rate(demo_memory_usage_bytes[1m])
```

<img width="1252" height="770" alt="Screenshot 2025-07-18 101602" src="https://github.com/user-attachments/assets/9024377e-564c-49b6-adbe-88a7c60c3e32" />


<img width="1416" height="1251" alt="image" src="https://github.com/user-attachments/assets/74a73f68-c034-456d-9674-58731d12feb6" />


### تفاوت با انتخابگرهای بردار لحظه‌ای
- **بازه زمانی قابل‌انتخاب**: می‌توانید بازه زمانی (مانند 1 دقیقه، 5 دقیقه یا 1 ساعت) را آزادانه انتخاب کنید.
- **نادیده گرفتن علامت‌های منسوخ بودن**: علامت‌های منسوخ بودن در انتخابگرهای بردار بازه‌ای نادیده گرفته می‌شوند و تمام نمونه‌های موجود در بازه زمانی انتخاب می‌شوند.

## اصلاح‌کننده آفست (Offset Modifier)

برای هر دو نوع انتخابگر، می‌توانید پنجره انتخاب داده را با استفاده از اصلاح‌کننده `offset` به گذشته منتقل کنید.

#### مثال
```promql
demo_memory_usage_bytes offset 2m
```
این پرس‌وجو آخرین نمونه از `demo_memory_usage_bytes` را نسبت به 2 دقیقه قبل انتخاب می‌کند.

در حالت گرافیکی، آفست باعث می‌شود داده‌های گراف به سمت راست منتقل شوند، زیرا هر مرحله رزولوشن نمونه‌ای را انتخاب می‌کند که به اندازه مقدار آفست قدیمی‌تر است.

### موارد استفاده آفست
- **نمایش داده‌های با تأخیر زمانی**: برای نمایش داده‌ها با تأخیر ثابت نسبت به زمان فعلی.
- **مقایسه داده‌ها در زمان‌های مختلف**: برای مقایسه داده‌ها در بازه‌های زمانی مختلف در یک پرس‌وجو.
  ```promql
  demo_memory_usage_bytes - demo_memory_usage_bytes offset 1w
  ```
  این پرس‌وجو تفاوت مصرف حافظه فعلی را با مصرف حافظه یک هفته پیش محاسبه می‌کند.

## زمان‌بندی‌های ارزیابی مطلق (@ Modifier)

گاهی اوقات نیاز است داده‌ها نه نسبت به زمان‌بندی ارزیابی فعلی، بلکه نسبت به یک زمان‌بندی مطلق انتخاب شوند. این کار با اصلاح‌کننده `@` انجام می‌شود.

#### مثال
```promql
demo_memory_usage_bytes @ 1631234567
```
این پرس‌وجو داده‌ها را نسبت به زمان‌بندی یونیکس 1631234567 (در ثانیه) انتخاب می‌کند.

بهتر است از توابع شبه‌ای `start()` یا `end()` برای ارجاع به ابتدا یا انتهای بازه گراف استفاده کنید:
```promql
demo_memory_usage_bytes @ end()
```

### موارد استفاده
- **تثبیت سری‌های برتر یا پایین‌تر (top k/bottom k)**: برای اطمینان از نمایش مجموعه‌ای پایدار از سری‌ها در گراف.
- **ترکیب با آفست**: می‌توانید `@` را با `offset` ترکیب کنید تا پنجره انتخاب ابتدا به زمان‌بندی مطلق منتقل شود و سپس به عقب آفست شود.

## ترتیب نحوی اصلاح‌کننده‌ها

اگر می‌خواهید تمام ویژگی‌های انتخابگرها را ترکیب کنید، باید ترتیب نحوی درست را رعایت کنید:
1. نام متریک
2. تطبیق‌دهنده‌های برچسب `{}` (در صورت وجود)
3. بازه زمانی `[]` (برای بردار بازه‌ای)
4. اصلاح‌کننده `offset` (در صورت وجود)
5. اصلاح‌کننده `@` (در صورت وجود)

#### مثال کامل
```promql
demo_memory_usage_bytes{instance="instance1"}[1m] offset 1h @ 1631234567
```
این پرس‌وجو یک دقیقه داده از سری‌های زمانی `demo_memory_usage_bytes` برای `instance1` را انتخاب می‌کند، که نسبت به زمان‌بندی یونیکس 1631234567 و با آفست یک ساعت به گذشته است.

## نکات تکمیلی

- **درک رفتار انتخابگرها**: انتخابگرهای بردار لحظه‌ای و بازه‌ای هرکدام برای سناریوهای خاصی طراحی شده‌اند. انتخابگرهای لحظه‌ای برای نمایش مقادیر فعلی و انتخابگرهای بازه‌ای برای تحلیل روندها مناسب هستند.
- **مدیریت منسوخ بودن**: علامت‌های منسوخ بودن به بهبود دقت در حذف سری‌های غیرفعال کمک می‌کنند.
- **رزولوشن پرس‌وجو**: تنظیم رزولوشن مناسب در حالت گرافیکی برای نمایش دقیق‌تر داده‌ها اهمیت دارد.
- **منابع بیشتر**: برای اطلاعات عمیق‌تر در مورد موارد استفاده خاص مانند تثبیت سری‌های برتر یا پایین‌تر، به وبلاگ رسمی پرومتئوس مراجعه کنید.

این آموزش باید درک جامعی از انتخاب داده‌ها در پرومتئوس به شما ارائه دهد. برای یادگیری بیشتر، می‌توانید به دوره‌های آموزشی PromLabs مراجعه کنید.
