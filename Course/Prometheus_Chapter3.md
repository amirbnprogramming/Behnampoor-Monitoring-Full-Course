# قسمت سوم : پرومتئوس ، انواع متریک ها

در این بخش از آموزش پرومتئوس، به بررسی عمیق چهار نوع متریک اصلی در پرومتئوس می‌پردازیم: **Gauge**، **Counter**، **Summary** و **Histogram**. هر یک از این متریک‌ها برای موقعیت‌های خاصی استفاده می‌شوند و درک نحوه استفاده از آن‌ها در برنامه‌نویسی و کوئری‌نویسی با PromQL بسیار مهم است. در ادامه، هر نوع متریک را به‌صورت جداگانه بررسی می‌کنیم، ویژگی‌های آن‌ها را توضیح می‌دهیم و نحوه استفاده صحیح از آن‌ها را شرح می‌دهیم.

## 1. متریک‌های Gauge

### تعریف و کاربرد
متریک‌های **Gauge** ساده‌ترین نوع متریک در پرومتئوس هستند. این متریک‌ها برای اندازه‌گیری مقادیر عددی که به‌طور طبیعی می‌توانند **افزایش یا کاهش** یابند، استفاده می‌شوند. این نوع متریک برای نمایش وضعیت فعلی یک سیستم یا برنامه مناسب است، مانند:
- میزان استفاده از حافظه (Memory Usage)
- طول صف (Queue Length)
- فضای دیسک (Disk Space)
- دما (Temperature)

به‌طور کلی، متریک‌های Gauge مقادیری را نشان می‌دهند که در برنامه یا دنیای واقعی وجود دارند و شما صرفاً می‌خواهید آن‌ها را به‌عنوان یک متریک پرومتئوس نمایش دهید.

### روش‌های به‌روزرسانی در برنامه‌نویسی
هنگام استفاده از متریک‌های Gauge در برنامه، کتابخانه‌های کلاینت پرومتئوس روش‌های زیر را ارائه می‌دهند:
- ** تابع Set()**: تنظیم مقدار Gauge به یک مقدار دلخواه.
- ** توابع Inc() و Dec()**: افزایش یا کاهش مقدار فعلی به‌صورت نسبی (به میزان یک یا مقدار مشخص).
- **روش‌های کمکی برای ذخیره زمان**: برخی کتابخانه‌ها امکان ذخیره زمان به‌صورت Unix Timestamp را فراهم می‌کنند. این قابلیت برای ثبت زمان وقوع رویدادهایی مانند زمان بوت سیستم، شروع فرآیند یا آخرین اجرای یک کار دسته‌ای (Batch Job) مفید است.

### فرمت نمایش (Exposition Format)
در فرمت نمایش متریک‌ها، یک Gauge به‌صورت یک سری زمانی (Time Series) نمایش داده می‌شود. اگر برچسب‌های اضافی (Labels) استفاده نشود، تنها یک سری زمانی ساده خواهید داشت.

### کوئری‌نویسی با PromQL
ارزش فعلی یک Gauge به‌خودی‌خود معنادار است و معمولاً می‌توانید آن را مستقیماً در نمودارها نمایش دهید. بااین‌حال، می‌توانید عملیات‌های تجمیعی (Aggregations) یا سایر عملیات را روی آن اعمال کنید. برای مثال:
- برای Gauge‌هایی که حاوی زمان (Timestamp) هستند، می‌توانید با استفاده از تابع `time()` در PromQL، اختلاف زمانی بین مقدار فعلی و زمان ثبت‌شده را محاسبه کنید تا مدت زمان گذشته از یک رویداد را به دست آورید.

## 2. متریک‌های Counter

### تعریف و کاربرد
متریک‌های **Counter** برای شمارش تجمعی رویدادها یا مقادیر در طول زمان استفاده می‌شوند. این متریک‌ها **فقط می‌توانند افزایش یابند** و هرگز کاهش نمی‌یابند، مگر در مواردی که فرآیند ردیابی متریک (مانند سرور یا برنامه) ری‌استارت شود. مثال‌هایی از کاربرد Counter:
- تعداد کل درخواست‌های HTTP دریافت‌شده.
- مجموع زمان صرف‌شده (به ثانیه) برای پردازش درخواست‌ها.

### ری‌استارت و ریست شدن Counter
اگر فرآیند ردیابی متریک ری‌استارت شود، مقدار Counter به صفر ریست می‌شود. این وضعیت به‌عنوان **Counter Reset** شناخته می‌شود و PromQL می‌تواند به‌صورت خودکار این ریست‌ها را مدیریت کند.

### روش‌های به‌روزرسانی در برنامه‌نویسی
برای به‌روزرسانی متریک‌های Counter، دو روش اصلی وجود دارد:
- **تابع Inc()**: افزایش مقدار Counter به میزان یک واحد. این روش برای ثبت وقوع یک رویداد (مانند یک درخواست HTTP) استفاده می‌شود.
- ** تابع Add()**: افزایش مقدار Counter به میزان دلخواه (عدد صحیح یا اعشاری). این روش برای مواردی مانند ثبت زمان پردازش درخواست‌ها (که ممکن است اعشاری باشد) یا شمارش دسته‌ای از رویدادها مناسب است.

برخلاف Gauge، متریک‌های Counter هیچ روشی برای کاهش مقدار یا تنظیم مقدار مطلق ندارند، زیرا این کار با مفهوم Counter سازگار نیست.

### فرمت نمایش (Exposition Format)
در فرمت نمایش، Counterها شبیه به Gaugeها هستند، با این تفاوت که متادیتای اختیاری نوع متریک را به‌عنوان Counter مشخص می‌کند.

### کوئری‌نویسی با PromQL
مقدار مطلق یک Counter معمولاً اطلاعات مفیدی ارائه نمی‌دهد، زیرا این مقدار به زمان شروع Counter (که ممکن است یک سال یا یک دقیقه پیش باشد) وابسته است. به‌جای آن، باید **نرخ افزایش** Counter را در یک بازه زمانی خاص بررسی کنید. PromQL توابعی مانند `rate()`، `irate()` و `increase()` را برای این منظور ارائه می‌دهد:
- این توابع نرخ افزایش Counter را در یک بازه زمانی مشخص محاسبه می‌کنند.
- این توابع به‌صورت خودکار ریست‌های Counter را مدیریت می‌کنند و در صورت کاهش مقدار در بازه زمانی مشخص، آن را به‌عنوان ریست شناسایی کرده و اصلاح می‌کنند.

## 3. متریک‌های Summary

### تعریف و کاربرد
متریک‌های **Summary** برای ردیابی توزیع مقادیر عددی (مانند تأخیر درخواست‌ها) به‌صورت صدک‌ها (Percentiles) یا کوانتایل‌ها (Quantiles) استفاده می‌شوند. این متریک‌ها برای تحلیل آماری توزیع داده‌ها مناسب هستند.

### ایجاد و تنظیم Summary
هنگام ایجاد یک Summary، باید کوانتایل‌های موردنظر (مانند 0.5، 0.9، 0.99) و حاشیه خطا را مشخص کنید. سپس، با استفاده از متد **Observe()**، مقادیر خاصی (مانند تأخیر یک درخواست HTTP) را ثبت می‌کنید. برای مثال:
- اگر یک درخواست HTTP 2.3 ثانیه طول کشیده باشد، با فراخوانی `Observe(2.3)` این مقدار ثبت می‌شود.

قسمت Summary به‌طور خودکار کوانتایل‌های خروجی را با استفاده از الگوریتم‌های جریانی (Streaming Algorithms) به‌روزرسانی می‌کند.

### فرمت نمایش (Exposition Format)
در فرمت نمایش، یک Summary به مجموعه‌ای از سری‌های زمانی تبدیل می‌شود:
- یک سری زمانی برای هر کوانتایل محاسبه‌شده.
- سری زمانی `_count` برای تعداد کل مشاهدات.
- سری زمانی `_sum` برای مجموع مقادیر مشاهده‌شده.

برای مثال، در مورد تأخیر درخواست‌ها، `_count` تعداد کل درخواست‌ها و `_sum` مجموع زمان صرف‌شده برای پردازش درخواست‌ها را نشان می‌دهد.

### کوئری‌نویسی با PromQL
قسمت Summary را می‌توان به‌عنوان مجموعه‌ای از متریک‌های Gauge و Counter در نظر گرفت. در PromQL، می‌توانید از سری‌های زمانی جداگانه مانند Gauge یا Counter استفاده کنید. اما توجه کنید:

- **اجتناب از تجمیع کوانتایل‌ها**: تجمیع کوانتایل‌ها (مانند میانگین‌گیری از صدک 90 در چندین نمونه سرویس) از نظر آماری معتبر نیست. بنابراین، Summary برای مواردی مناسب است که نیازی به تجمیع در ابعاد مختلف (مانند نمونه‌های سرویس) ندارید.
- اگر نیاز به تجمیع دارید، باید از متریک‌های **Histogram** استفاده کنید.

## 4. متریک‌های Histogram

### تعریف و کاربرد
متریک‌های **Histogram** مشابه Summary هستند، زیرا توزیع مقادیر عددی را ردیابی می‌کنند. اما به‌جای محاسبه کوانتایل‌های از پیش تعیین‌شده، Histogram مقادیر را در **دسته‌های محدوده‌ای (Buckets)** شمارش می‌کند. این دسته‌ها نشان می‌دهند چه تعداد از مقادیر در هر محدوده (مثلاً درخواست‌های سریع، کند یا معمولی) قرار دارند.

### هیستوگرام‌های تجمعی (Cumulative Histograms)
در پرومتئوس، هیستوگرام‌ها به‌صورت **تجمعی** هستند، به این معنا که هر دسته شامل تعداد مقادیر تمام دسته‌های با محدوده پایین‌تر نیز می‌شود. این ویژگی باعث می‌شود که只需要 تعریف مرز بالایی هر دسته کافی باشد، زیرا هر دسته به‌طور ضمنی از صفر شروع می‌شود.

### ایجاد و تنظیم Histogram
هنگام ایجاد یک Histogram، باید مجموعه‌ای از محدوده‌های دسته‌ها (Bucket Ranges) را مشخص کنید. سپس، با استفاده از متد **Observe()**، مقادیر را ثبت می‌کنید. Histogram به‌طور خودکار شمارش دسته‌های مناسب را افزایش می‌دهد.

### فرمت نمایش (Exposition Format)
در فرمت نمایش، هر دسته Histogram به‌عنوان یک سری زمانی Counter با برچسب `le` (مخفف Less than or Equal) نمایش داده می‌شود. این برچسب نشان‌دهنده مرز بالایی دسته است. برای مثال:
- دسته‌ای با برچسب `le="0.2"` تعداد تمام درخواست‌هایی را نشان می‌دهد که کمتر یا مساوی 0.2 ثانیه طول کشیده‌اند.
- مشابه Summary، سری‌های زمانی `_count` و `_sum` نیز ارائه می‌شوند.

### انتخاب تعداد و محدوده دسته‌ها
انتخاب تعداد و محدوده دسته‌ها یک تعادل بین **دقت** و **هزینه** است:
- دسته‌های بیشتر و دقیق‌تر، وضوح بهتری ارائه می‌دهند، اما می‌توانند سرور پرومتئوس را تحت فشار قرار دهند.
- برای اطلاعات بیشتر در مورد استراتژی‌های انتخاب دسته‌ها، به مستندات پرومتئوس مراجعه کنید.

### کوئری‌نویسی با PromQL
می‌توانید هر دسته Histogram را به‌صورت جداگانه مانند یک Counter کوئری کنید. اما رایج‌ترین کاربرد، محاسبه کوانتایل‌های تقریبی با استفاده از تابع `histogram_quantile()` است. این تابع تنها تابع در PromQL است که برچسب‌های `le` را درک می‌کند. نکات مهم:
- معمولاً باید توابع `rate()` یا `increase()` را روی دسته‌های Histogram اعمال کنید تا داده‌ها را به یک بازه زمانی مشخص محدود کنید.
- هنگام تجمیع (مانند استفاده از عملگر `sum`)، باید برچسب `le` را حفظ کنید تا Histogram معتبر باقی بماند.

### محاسبه میانگین تأخیر
هم Summary و هم Histogram امکان محاسبه میانگین تأخیر درخواست‌ها را با استفاده از `_sum` و `_count` فراهم می‌کنند. این روش ارزان‌تر از تحلیل توزیع است و گاهی اوقات مفید خواهد بود.

## هیستوگرام‌های بومی (Native Histograms)
اخیراً نوع جدیدی از هیستوگرام‌ها به نام **Native Histograms** در پرومتئوس معرفی شده است که هنوز در مرحله آزمایشی قرار دارد. این نوع هیستوگرام امکان ذخیره یک هیستوگرام کامل را در یک نمونه سری زمانی به‌صورت کارآمد فراهم می‌کند. این ویژگی با تمام متریک‌های دیگر متفاوت است و در آینده جزئیات بیشتری در مورد آن ارائه خواهد شد.

## جمع‌بندی
در این بخش، چهار نوع متریک پرومتئوس (Gauge، Counter، Summary و Histogram) را به‌صورت عمیق بررسی کردیم. هر نوع متریک کاربرد خاص خود را دارد:
- ** نوع Gauge** برای مقادیر متغیر مانند دما یا استفاده از حافظه.
- ** نوع Counter** برای شمارش تجمعی رویدادها مانند تعداد درخواست‌ها.
- **نوع Summary** برای محاسبه کوانتایل‌های توزیع بدون نیاز به تجمیع.
- **نوع Histogram** برای تحلیل توزیع با امکان تجمیع و محاسبه کوانتایل‌های تقریبی.

درک این متریک‌ها و استفاده صحیح از آن‌ها در برنامه‌نویسی و کوئری‌نویسی با PromQL برای بهره‌برداری کامل از قابلیت‌های پرومتئوس ضروری است.

