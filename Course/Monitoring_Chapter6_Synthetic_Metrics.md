# آموزش پرومتئوس - قسمت ششم متریک‌های مصنوعی (Synthetic Metrics)

در این قسمت از سری آموزش‌های پرومتئوس، به بررسی متریک‌های مصنوعی (Synthetic Metrics) می‌پردازیم که به‌صورت خودکار توسط پرومتئوس تولید و ذخیره می‌شوند، حتی اگر از هدف‌های مانیتورینگ (targets) شما مستقیماً نشأت نگرفته باشند. معروف‌ترین این متریک‌ها، متریک `up` است، اما متریک‌های دیگری نیز وجود دارند که بسیار کاربردی هستند. هدف این آموزش، توضیح عمیق نحوه تولید این متریک‌ها، کاربردهای آن‌ها و ارائه مثال‌های عملی برای استفاده بهینه در مانیتورینگ است.

## متریک‌های مصنوعی چیستند؟

متریک‌های مصنوعی، معیارهایی هستند که پرومتئوس به‌صورت خودکار برای هر **اسکرپ (scrape)** از یک هدف (target) تولید می‌کند. این متریک‌ها در فرمت exposition هدف‌ها وجود ندارند، بلکه توسط خود پرومتئوس ایجاد می‌شوند تا اطلاعاتی درباره وضعیت اسکرپ و هدف ارائه دهند. این متریک‌ها شامل برچسب‌هایی (labels) هستند که با برچسب‌های هدف در تنظیمات پرومتئوس (مانند `instance` و `job`) مطابقت دارند.

**چرا مهم‌اند؟**
- اطلاعاتی درباره سلامت و عملکرد اسکرپ‌ها ارائه می‌دهند.
- به شناسایی مشکلات در اهداف (مانند قطعی یا کندی) کمک می‌کنند.
- برای بهینه‌سازی پیکربندی و مانیتورینگ سیستم بسیار مفیدند.

## متریک `up`

### تعریف
متریک `up` نشان‌دهنده وضعیت سلامت اسکرپ یک هدف است:
- **مقدار ۱**: اسکرپ با موفقیت انجام شده است.
- **مقدار ۰**: اسکرپ ناموفق بوده (مثلاً به دلیل خطا در فرمت exposition، مشکل DNS، تایم‌اوت یا قطعی اتصال).

### کاربرد
- **هشدار سلامت پایه:** می‌توانید از `up == 0` برای شناسایی اهدافی که در دسترس نیستند استفاده کنید.
- **مانیتورینگ ساده:** بررسی کنید که آیا پرومتئوس به تمام اهداف دسترسی دارد یا خیر.

### مثال عملی
فرض کنید یک وب‌سرور با نام `webserver:8080` و شغل (job) به نام `web` را مانیتور می‌کنید. در صفحه **Targets** پرومتئوس، می‌بینید که این هدف به‌درستی اسکرپ می‌شود. حالا اگر وب‌سرور خاموش شود:
- متریک `up{job="web", instance="webserver:8080"}` از ۱ به ۰ تغییر می‌کند.

برای تنظیم هشدار:
```promql
ALERT WebServerDown
  IF up{job="web"} == 0
  FOR 5m
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = "وب‌سرور از دسترس خارج شده است",
    description = "{{ $labels.instance }} برای بیش از ۵ دقیقه در دسترس نیست."
  }
```

این هشدار اگر هدف برای ۵ دقیقه در دسترس نباشد، فعال می‌شود.

## سایر متریک‌های مصنوعی

علاوه بر `up`، پرومتئوس متریک‌های دیگری نیز تولید می‌کند که در ادامه بررسی می‌کنیم:

### ۱. `متریک مصنوعی scrape_duration_seconds`
**تعریف:** مدت‌زمان (به ثانیه) هر اسکرپ را نشان می‌دهد.

**کاربرد:**
- شناسایی اهدافی که اسکرپ آن‌ها کند است (مثلاً به دلیل بار زیاد یا مشکلات شبکه).
- بهینه‌سازی تنظیمات اسکرپ (مثل افزایش تایم‌اوت برای اهداف کند).

**مثال:**
فرض کنید یک هدف (مثل یک API) به دلیل بار زیاد، اسکرپ آن ۴ ثانیه طول می‌کشد:
```promql
scrape_duration_seconds{job="api"} > 3
```
این کوئری اهدافی را نشان می‌دهد که اسکرپ آن‌ها بیش از ۳ ثانیه طول می‌کشد. می‌توانید هشدار تنظیم کنید تا تیم توسعه را از کندی مطلع کند.

### ۲. `متریک مصنوعی scrape_samples_scraped`
**تعریف:** تعداد نمونه‌های (samples) اسکرپ‌شده از یک هدف در هر اسکرپ.

**کاربرد:**
- شناسایی اهدافی که تعداد زیادی متریک تولید می‌کنند (ممکن است باعث فشار روی پرومتئوس شوند).
- بهینه‌سازی تعداد متریک‌های جمع‌آوری‌شده.

**مثال:**
اگر یک هدف (مثل یک اپلیکیشن پیچیده) ۱۰,۰۰۰ نمونه در هر اسکرپ تولید کند:
```promql
scrape_samples_scraped{job="complex_app"} > 5000
```
این کوئری نشان می‌دهد که هدف بیش از حد متریک تولید می‌کند. می‌توانید با استفاده از **relabeling** تعداد متریک‌ها را کاهش دهید.

### ۳. ` متریک مصنوعی scrape_samples_postrelabeling`
**تعریف:** تعداد نمونه‌های باقی‌مانده پس از اعمال قوانین relabeling.

**کاربرد:**
- بررسی تأثیر قوانین relabeling (مثل حذف متریک‌های غیرضروری).
- اطمینان از اینکه فیلترهای شما به‌درستی کار می‌کنند.

**مثال:**
فرض کنید قانونی برای حذف متریک‌های خاصی از هدف تنظیم کرده‌اید:
```promql
scrape_samples_scraped{job="app"} - scrape_samples_postrelabeling{job="app"}
```
این کوئری تعداد نمونه‌های حذف‌شده توسط relabeling را نشان می‌دهد.

### ۴. ` متریک مصنوعی scrape_series_added`
**تعریف:** تعداد سری‌های زمانی جدیدی که در هر اسکرپ به هدف اضافه شده‌اند.

**کاربرد:**
- شناسایی اهدافی که سری‌های زمانی زیادی تولید می‌کنند (چرخش زیاد یا churn).
- جلوگیری از فشار روی پرومتئوس به دلیل ذخیره و ایندکس کردن سری‌های زمانی جدید.

**مثال:**
اگر یک هدف به دلیل تغییرات مداوم (مثل اضافه شدن برچسب‌های پویا) سری‌های زمانی زیادی تولید کند:
```promql
scrape_series_added{job="dynamic_app"} > 100
```
این کوئری اهدافی را نشان می‌دهد که بیش از ۱۰۰ سری زمانی جدید در هر اسکرپ اضافه می‌کنند. می‌توانید با تنظیم قوانین relabeling این مشکل را کاهش دهید.

## نحوه تولید و برچسب‌گذاری متریک‌های مصنوعی

متریک‌های مصنوعی با برچسب‌هایی تولید می‌شوند که با برچسب‌های هدف (مانند `job` و `instance`) مطابقت دارند. اگر در تنظیمات پرومتئوس یا سرویس دیسکاوری (Service Discovery) برچسب‌ها را تغییر دهید، این تغییرات در متریک‌های مصنوعی نیز اعمال می‌شوند.

**مثال تنظیمات پرومتئوس:**
```yaml
scrape_configs:
  - job_name: 'web'
    static_configs:
      - targets: ['webserver:8080']
        labels:
          env: 'production'
```
متریک `up` برای این هدف به‌صورت زیر خواهد بود:
```
up{job="web", instance="webserver:8080", env="production"} 1
```

## نکات کاربردی

1. **تنظیم بازه اسکرپ:** فاصله اسکرپ (scrape interval) را کوتاه (مثلاً ۵-۱۵ ثانیه) نگه دارید تا متریک‌های مصنوعی (مثل `up`) به‌سرعت تغییرات را نشان دهند.
2. **هشدارهای پیشرفته:** از ترکیب متریک‌های مصنوعی با سایر متریک‌ها برای هشدارهای پیچیده‌تر استفاده کنید. مثلاً:
   ```promql
   rate(http_requests_total{job="web"}[5m]) > 0 and up{job="web"} == 1
   ```
   این کوئری بررسی می‌کند که هدف در دسترس است و نرخ درخواست‌ها مثبت است.
3. **بهینه‌سازی با relabeling:** اگر تعداد نمونه‌ها یا سری‌های زمانی زیاد است، از قوانین relabeling استفاده کنید:
   ```yaml
   relabel_configs:
     - source_labels: [__name__]
       regex: (unwanted_metric.*)
       action: drop
   ```
   این قانون متریک‌های ناخواسته را حذف می‌کند.
4. **مانیتورینگ پرومتئوس:** پرومتئوس خودش را نیز اسکرپ می‌کند! از متریک‌های مصنوعی برای مانیتورینگ سلامت سرور پرومتئوس استفاده کنید.

## مثال جامع: مانیتورینگ یک اپلیکیشن
فرض کنید اپلیکیشن شما با نام شغل `app` و نمونه `app:9000` مانیتور می‌شود. می‌خواهید:
- سلامت هدف را بررسی کنید.
- کندی اسکرپ را تشخیص دهید.
- تعداد سری‌های زمانی جدید را محدود کنید.

**کوئری‌ها:**
1. سلامت: `up{job="app"}`
2. کندی اسکرپ: `scrape_duration_seconds{job="app"} > 2`
3. سری‌های زمانی جدید: `scrape_series_added{job="app"} > 50`

**هشدار:**
```promql
ALERT SlowScrape
  IF scrape_duration_seconds{job="app"} > 2
  FOR 5m
  LABELS { severity = "warning" }
  ANNOTATIONS {
    summary = "اسکرپ کند برای {{ $labels.instance }}",
    description = "مد couleurs: t زمان اسکرپ {{ $labels.instance }} بیش از ۲ ثانیه است."
  }
```

## مستندات پرومتئوس
برای اطلاعات بیشتر، به بخش **Automatically Generated Labels and Time Series** در مستندات پرومتئوس مراجعه کنید (در مسیر Concepts > Jobs and Instances). این بخش توضیحات کاملی درباره متریک‌های مصنوعی ارائه می‌دهد.

## جمع‌بندی
متریک‌های مصنوعی پرومتئوس ابزارهای قدرتمندی برای مانیتورینگ سلامت و عملکرد اسکرپ‌ها هستند. متریک `up` برای بررسی دسترسی‌پذیری، `scrape_duration_seconds` برای تشخیص کندی، `scrape_samples_scraped` و `scrape_samples_postrelabeling` برای مدیریت تعداد متریک‌ها و `scrape_series_added` برای کنترل چرخش سری‌های زمانی استفاده می‌شوند. با استفاده از این متریک‌ها و تنظیمات مناسب، می‌توانید سیستم مانیتورینگ خود را بهینه و پایدار نگه دارید.
